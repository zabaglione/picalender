# TASK-102: レンダリングループ実装 - テストケース

## テストケース一覧

### 1. RenderLoop基本テスト

#### TC-001: RenderLoopの初期化
- **前提条件**: DisplayManagerが初期化済み
- **実行**: RenderLoopを初期化
- **期待結果**: エラーなく初期化される
- **検証項目**:
  - RenderLoopインスタンスが作成される
  - target_fpsが設定される
  - 初期状態がSTOPPED

#### TC-002: ループの開始
- **前提条件**: RenderLoopが初期化済み
- **実行**: `start()`メソッドを呼び出し
- **期待結果**: ループが開始される
- **検証項目**:
  - 状態がRUNNINGになる
  - FPSカウンターが動作開始
  - update/renderが呼ばれる

#### TC-003: ループの停止
- **前提条件**: ループが実行中
- **実行**: `stop()`メソッドを呼び出し
- **期待結果**: ループが停止する
- **検証項目**:
  - 状態がSTOPPEDになる
  - クリーンアップが実行される
  - リソースが解放される

#### TC-004: 一時停止と再開
- **前提条件**: ループが実行中
- **実行**: `pause()`→`resume()`
- **期待結果**: 一時停止後、再開される
- **検証項目**:
  - 状態がPAUSED→RUNNINGに変化
  - 一時停止中は更新が止まる
  - 再開後は正常動作

### 2. FPS制御テスト

#### TC-005: 目標FPS維持
- **前提条件**: 30FPS設定でループ実行
- **実行**: 1秒間ループを実行
- **期待結果**: 30±1 FPSで動作
- **検証項目**:
  - 実測FPSが29-31の範囲
  - フレーム時間が約33ms

#### TC-006: フレームスキップ
- **前提条件**: 処理が重い状況
- **実行**: 意図的に遅延を発生
- **期待結果**: フレームスキップが発生
- **検証項目**:
  - 更新は継続される
  - 描画がスキップされる
  - FPSが回復する

#### TC-007: FPS統計取得
- **前提条件**: ループが実行中
- **実行**: `get_stats()`を呼び出し
- **期待結果**: 統計情報が取得できる
- **検証項目**:
  - 現在のFPS
  - 平均フレーム時間
  - フレームドロップ数

### 3. イベント処理テスト

#### TC-008: イベントハンドラー登録
- **前提条件**: RenderLoopが初期化済み
- **実行**: ハンドラーを登録
- **期待結果**: ハンドラーが登録される
- **検証項目**:
  - ハンドラーリストに追加
  - 複数登録可能

#### TC-009: イベント処理
- **前提条件**: ハンドラー登録済み
- **実行**: イベントを発生させる
- **期待結果**: ハンドラーが呼ばれる
- **検証項目**:
  - 正しいハンドラーが実行
  - イベントデータが渡される

#### TC-010: システムイベント処理
- **前提条件**: ループ実行中
- **実行**: QUITイベント発生
- **期待結果**: ループが終了
- **検証項目**:
  - グレースフルシャットダウン
  - クリーンアップ実行

### 4. レイヤー管理テスト

#### TC-011: レイヤー追加
- **前提条件**: RenderLoop初期化済み
- **実行**: `add_layer()`でレイヤー追加
- **期待結果**: レイヤーが追加される
- **検証項目**:
  - レイヤーリストに追加
  - 優先順位が設定される

#### TC-012: レイヤー削除
- **前提条件**: レイヤーが追加済み
- **実行**: `remove_layer()`
- **期待結果**: レイヤーが削除される
- **検証項目**:
  - レイヤーリストから削除
  - リソースが解放される

#### TC-013: レイヤー優先順位
- **前提条件**: 複数レイヤー追加
- **実行**: 異なる優先順位で追加
- **期待結果**: 優先順に描画される
- **検証項目**:
  - 描画順序が正しい
  - 高優先度が前面に描画

#### TC-014: レイヤー表示/非表示
- **前提条件**: レイヤー追加済み
- **実行**: `set_visible(false)`
- **期待結果**: レイヤーが非表示になる
- **検証項目**:
  - renderが呼ばれない
  - updateは継続される

### 5. Renderableインターフェーステスト

#### TC-015: Renderable追加
- **前提条件**: レイヤー作成済み
- **実行**: Renderableオブジェクト追加
- **期待結果**: オブジェクトが追加される
- **検証項目**:
  - レイヤーに含まれる
  - update/renderが呼ばれる

#### TC-016: Renderable更新
- **前提条件**: Renderableが追加済み
- **実行**: フレーム更新処理
- **期待結果**: update()が呼ばれる
- **検証項目**:
  - デルタタイムが渡される
  - 状態が更新される

#### TC-017: Renderable描画
- **前提条件**: Renderableが追加済み
- **実行**: フレーム描画処理
- **期待結果**: render()が呼ばれる
- **検証項目**:
  - surfaceに描画される
  - ダーティ領域が返される

### 6. ダーティリージョン管理テスト

#### TC-018: ダーティ領域追加
- **前提条件**: DirtyRegionManager初期化
- **実行**: `add_rect()`で領域追加
- **期待結果**: 領域が記録される
- **検証項目**:
  - リストに追加される
  - 重複が除去される

#### TC-019: ダーティ領域結合
- **前提条件**: 複数の領域追加
- **実行**: `union_rects()`
- **期待結果**: 領域が結合される
- **検証項目**:
  - 最小包含矩形になる
  - 効率的な結合

#### TC-020: 部分更新
- **前提条件**: ダーティ領域あり
- **実行**: 画面更新処理
- **期待結果**: 部分的に更新される
- **検証項目**:
  - 指定領域のみ更新
  - パフォーマンス向上

### 7. エラー処理テスト

#### TC-021: レンダリングエラー処理
- **前提条件**: エラーを発生させる
- **実行**: render()で例外発生
- **期待結果**: ループは継続
- **検証項目**:
  - エラーログ出力
  - 他のオブジェクトは描画継続
  - クラッシュしない

#### TC-022: イベントハンドラーエラー
- **前提条件**: ハンドラーで例外
- **実行**: イベント処理中に例外
- **期待結果**: ループは継続
- **検証項目**:
  - エラーログ出力
  - 他のハンドラーは実行
  - イベント処理継続

#### TC-023: メモリ不足対応
- **前提条件**: メモリ逼迫状態
- **実行**: メモリ不足をシミュレート
- **期待結果**: グレースフル劣化
- **検証項目**:
  - 品質を下げて継続
  - 警告ログ出力

### 8. パフォーマンステスト

#### TC-024: CPU使用率
- **前提条件**: 標準的な負荷
- **実行**: 10秒間実行
- **期待結果**: CPU使用率30%未満
- **検証項目**:
  - CPU使用率測定
  - 目標値以下

#### TC-025: メモリ使用量
- **前提条件**: 標準的な構成
- **実行**: メモリ測定
- **期待結果**: 追加50MB以内
- **検証項目**:
  - メモリ増加量測定
  - リークがない

#### TC-026: 長時間動作
- **前提条件**: 標準構成
- **実行**: 1時間連続動作
- **期待結果**: 安定動作
- **検証項目**:
  - FPS安定
  - メモリリークなし
  - エラーなし

### 9. 統合テスト

#### TC-027: DisplayManagerとの連携
- **前提条件**: DisplayManager初期化
- **実行**: RenderLoop実行
- **期待結果**: 正常に描画
- **検証項目**:
  - 画面に表示される
  - flip/updateが呼ばれる

#### TC-028: 複数レイヤー動作
- **前提条件**: 3つのレイヤー
- **実行**: 全レイヤー更新/描画
- **期待結果**: 正しく合成される
- **検証項目**:
  - レイヤー順序正しい
  - 透明度が機能
  - パフォーマンス維持

#### TC-029: 実使用シナリオ
- **前提条件**: 実際の使用状況
- **実行**: 時計・カレンダー表示
- **期待結果**: 滑らかな動作
- **検証項目**:
  - 30FPS維持
  - 応答性良好
  - 見た目が正しい

## テスト実行計画

1. 単体テスト（TC-001〜TC-023）
2. パフォーマンステスト（TC-024〜TC-026）
3. 統合テスト（TC-027〜TC-029）

## 合格基準

- 全テストケースの95%以上が成功
- パフォーマンステストが目標値を達成
- 長時間動作テストでエラーなし