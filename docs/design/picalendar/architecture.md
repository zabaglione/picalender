# PiCalendar アーキテクチャ設計

## システム概要

PiCalendarは、Raspberry Pi Zero 2 W上で動作する常時表示型の情報端末アプリケーションです。
SDL2/KMSDRMを使用した直接描画により、X Window Systemを使用せずに高性能な描画を実現します。
単一プロセス・マルチスレッドアーキテクチャを採用し、リソース制約のある環境でも効率的に動作します。

## アーキテクチャパターン

- **パターン**: レイヤードアーキテクチャ + イベント駆動
- **理由**: 
  - 描画層、ビジネスロジック層、データ層を明確に分離
  - リアルタイム更新が必要な時計表示と非同期な天気取得を効率的に処理
  - リソース制約下での最適なパフォーマンスを実現

## システム構成図

```
┌─────────────────────────────────────────────────────────┐
│                    Raspberry Pi Zero 2 W                 │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │              PiCalendar Application                 │ │
│  │                                                     │ │
│  │  ┌──────────────────────────────────────────────┐  │ │
│  │  │           Presentation Layer                  │  │ │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐    │  │ │
│  │  │  │  Clock   │ │ Calendar │ │ Weather  │    │  │ │
│  │  │  │ Renderer │ │ Renderer │ │ Renderer │    │  │ │
│  │  │  └──────────┘ └──────────┘ └──────────┘    │  │ │
│  │  │  ┌──────────┐ ┌──────────┐                  │  │ │
│  │  │  │Background│ │Character │                  │  │ │
│  │  │  │ Renderer │ │Animator  │                  │  │ │
│  │  │  └──────────┘ └──────────┘                  │  │ │
│  │  └──────────────────────────────────────────────┘  │ │
│  │                                                     │ │
│  │  ┌──────────────────────────────────────────────┐  │ │
│  │  │           Business Logic Layer               │  │ │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐    │  │ │
│  │  │  │  Time    │ │ Calendar │ │ Weather  │    │  │ │
│  │  │  │ Manager  │ │ Manager  │ │ Manager  │    │  │ │
│  │  │  └──────────┘ └──────────┘ └──────────┘    │  │ │
│  │  │  ┌──────────┐ ┌──────────┐                  │  │ │
│  │  │  │  Asset   │ │ Config   │                  │  │ │
│  │  │  │ Manager  │ │ Manager  │                  │  │ │
│  │  │  └──────────┘ └──────────┘                  │  │ │
│  │  └──────────────────────────────────────────────┘  │ │
│  │                                                     │ │
│  │  ┌──────────────────────────────────────────────┐  │ │
│  │  │              Data Access Layer               │  │ │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐    │  │ │
│  │  │  │ Weather  │ │  Cache   │ │  File    │    │  │ │
│  │  │  │ Provider │ │ Storage  │ │  System  │    │  │ │
│  │  │  └──────────┘ └──────────┘ └──────────┘    │  │ │
│  │  └──────────────────────────────────────────────┘  │ │
│  │                                                     │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │                  System Services                    │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐          │ │
│  │  │ systemd  │ │  pygame  │ │ Network  │          │ │
│  │  │ Service  │ │SDL2/KMSDRM│ │  Stack   │          │ │
│  │  └──────────┘ └──────────┘ └──────────┘          │ │
│  └────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## コンポーネント構成

### 表示層（Presentation Layer）

- **フレームワーク**: pygame 2.x (SDL2バックエンド)
- **描画方式**: KMSDRM直接描画（X不使用）
- **レンダリング戦略**:
  - ダーティリージョン管理による部分更新
  - レイヤーベースの合成（背景→時計→カレンダー→天気→キャラクター）
  - 更新頻度の最適化（時計:1秒、カレンダー:1分、天気:取得時）

### ビジネスロジック層（Business Logic Layer）

- **時刻管理**: システムローカル時刻の取得と整形
- **カレンダー生成**: Python標準calendarモジュール活用
- **天気管理**: プロバイダ抽象化、キャッシュ管理
- **設定管理**: YAML設定ファイルの読み込みと検証
- **アセット管理**: フォント、画像、スプライトの動的ロード

### データアクセス層（Data Access Layer）

- **天気プロバイダ**: 
  - 抽象基底クラスによるプロバイダインターフェース
  - Open-Meteo実装（テスト用）
  - Yahoo天気実装（本番用）
- **キャッシュストレージ**: 
  - JSONファイルベースの天気データキャッシュ
  - メモリ内キャッシュ（設定、アセット）
- **ファイルシステム**: 
  - 設定ファイル読み込み
  - アセットファイル管理
  - ログファイル出力

## スレッドモデル

```python
# メインスレッド
- pygame初期化
- 描画ループ（30 FPS）
- イベント処理
- レンダリング制御

# ワーカースレッド
- 天気情報取得（30分間隔）
- 背景画像スキャン（5分間隔）
- キャッシュ管理

# スレッド間通信
- queue.Queue によるスレッドセーフな通信
- ロックフリーな読み取り専用共有データ
```

## メモリ管理戦略

- **静的アロケーション**: 起動時に必要なリソースを事前確保
- **画像最適化**: 必要サイズへの事前スケーリング
- **オブジェクトプール**: フォントレンダリング結果のキャッシュ
- **ガベージコレクション**: 定期的な明示的GC実行

## エラーハンドリング戦略

1. **フェイルセーフ動作**
   - 天気取得失敗 → キャッシュ表示
   - アセット読み込み失敗 → デフォルト表示
   - 設定エラー → デフォルト値使用

2. **自動復旧**
   - systemdによる自動再起動
   - ネットワーク再接続の自動リトライ
   - メモリ不足時の自動クリーンアップ

3. **ログ戦略**
   - 構造化ログ（時刻、レベル、モジュール、メッセージ）
   - journaldへの統合
   - エラー時の詳細コンテキスト記録

## パフォーマンス最適化

1. **描画最適化**
   - 静的要素の事前レンダリング
   - ダーティリージョンによる部分更新
   - アルファブレンディングの最小化

2. **CPU最適化**
   - 更新頻度の差別化（秒/分/取得時）
   - スリープによるCPU使用率制御
   - 不要な計算の事前キャッシュ

3. **メモリ最適化**
   - 画像の適切な圧縮とフォーマット選択
   - 不要オブジェクトの即時解放
   - メモリプールの活用

## セキュリティ設計

- **認証情報管理**: 
  - .envファイルによる分離
  - 環境変数経由の読み込み
  - ログからの除外

- **通信セキュリティ**:
  - HTTPS必須
  - 証明書検証有効
  - タイムアウト設定

- **権限管理**:
  - 非rootユーザー実行
  - 最小権限の原則
  - ファイルアクセス制限

## 拡張性考慮

- **プラガブルアーキテクチャ**:
  - 天気プロバイダの追加が容易
  - 新規ウィジェットの追加が可能
  - テーマ/スキンのサポート

- **設定駆動開発**:
  - レイアウトの外部設定化
  - 動作パラメータの調整可能
  - 機能の有効/無効切り替え

- **将来の機能拡張**:
  - 祝日カレンダー統合
  - スケジュール表示
  - 通知機能
  - 音声出力対応