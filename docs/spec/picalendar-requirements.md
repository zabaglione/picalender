# PiCalendar 要件定義書

## 概要

Raspberry Pi Zero 2 W と 1024×600 ディスプレイを使用した常時表示型の情報端末アプリケーション。時計、カレンダー、天気予報、オプションの2Dキャラクターアニメーションを表示し、電源投入後自動起動でキオスクモードとして動作する。ネットワーク断絶時でも基本機能（時計・カレンダー）は継続動作する高可用性を実現する。

## ユーザストーリー

### ストーリー1: 常時情報表示端末としての利用

- **である** 家庭や小規模オフィスのユーザー **として**
- **私は** 電源を入れるだけで時計、カレンダー、天気情報が常時表示される端末 **をしたい**
- **そうすることで** 日常生活で必要な情報を一目で確認できる

### ストーリー2: オフライン時の継続利用

- **である** ネットワーク環境が不安定な場所のユーザー **として**
- **私は** インターネット接続が切れても時計とカレンダーは表示し続ける端末 **をしたい**
- **そうすることで** 最低限の情報は常に確認できる

### ストーリー3: カスタマイズ可能な表示

- **である** 個人の好みがあるユーザー **として**
- **私は** 背景画像やキャラクター、フォントサイズなどをカスタマイズできる端末 **をしたい**
- **そうすることで** 自分の環境や好みに合わせた表示にできる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは現在時刻を時:分:秒の形式で毎秒更新して表示しなければならない
- REQ-002: システムは現在日付をYYYY-MM-DD (曜日)の形式で毎分更新して表示しなければならない
- REQ-003: システムは当月のカレンダーを日曜始まりの7×6グリッドで表示しなければならない
- REQ-004: システムは3日分の天気予報（日付、最高/最低気温、降水確率、天気アイコン）を表示しなければならない
- REQ-005: システムは1024×600の解像度でフルスクリーン表示しなければならない
- REQ-006: システムは電源投入時に自動的にアプリケーションを起動しなければならない
- REQ-007: システムはマウスカーソルを非表示にしなければならない
- REQ-008: システムは背景画像を表示し、fit（レターボックス）またはscale（拡大）モードで描画しなければならない
- REQ-009: システムはsettings.yamlファイルから設定を読み込まなければならない
- REQ-010: システムは天気情報を設定された間隔（デフォルト30分）で更新しなければならない

### 条件付き要件

- REQ-101: ネットワーク接続が利用可能な場合、システムは天気予報APIから最新の情報を取得しなければならない
- REQ-102: ネットワーク接続が切断された場合、システムは最後に取得した天気情報をキャッシュから表示しなければならない
- REQ-103: 天気情報のキャッシュが存在しない場合、システムは「天気情報取得不可」と表示しなければならない
- REQ-104: 日曜日の場合、システムはカレンダーの日付を赤色で表示しなければならない
- REQ-105: 土曜日の場合、システムはカレンダーの日付を青色で表示しなければならない
- REQ-106: 平日の場合、システムはカレンダーの日付を白色で表示しなければならない
- REQ-107: 月が変わった場合、システムは自動的に新しい月のカレンダーに切り替えなければならない
- REQ-108: 設定で2Dキャラクターが有効な場合、システムはスプライトアニメーションを表示しなければならない
- REQ-109: wallpapersディレクトリに新しい画像が追加された場合、システムは設定された間隔（デフォルト300秒）で画像を再スキャンしなければならない
- REQ-110: Yahoo天気APIを使用する場合、システムはクレジット表記を表示しなければならない

### 状態要件

- REQ-201: 初期起動状態にある場合、システムは10秒以内にフルスクリーン表示を開始しなければならない
- REQ-202: 天気情報取得中の場合、システムは前回の天気情報を表示し続けなければならない
- REQ-203: エラー発生状態の場合、システムはエラーをログに記録し、可能な限り動作を継続しなければならない
- REQ-204: systemdサービスとして実行中の場合、システムは異常終了時に自動的に再起動しなければならない

### オプション要件

- REQ-301: システムは2Dキャラクターのスプライトアニメーションを8fps程度で表示してもよい
- REQ-302: システムは複数の背景画像をローテーション表示してもよい
- REQ-303: システムは祝日情報を表示してもよい（将来拡張）
- REQ-304: システムは六曜を表示してもよい（将来拡張）
- REQ-305: システムはICSファイルからスケジュール情報を読み込んで表示してもよい（将来拡張）
- REQ-306: システムは時間帯に応じて画面の輝度を調整してもよい（将来拡張）

### 制約要件

- REQ-401: システムはPython 3.11以上で実装されなければならない
- REQ-402: システムはpygameライブラリを使用してSDL2/KMSDRM経由で直接描画しなければならない
- REQ-403: システムはX Window Systemを使用してはならない
- REQ-404: システムはCPU使用率を平均30%未満（キャラクター無効時）に抑えなければならない
- REQ-405: システムはメモリ使用量を180MB以下（キャラクター無効時）に抑えなければならない
- REQ-406: システムはAPIキーを平文でsettings.yamlに保存してはならない
- REQ-407: システムは外部APIとの通信にHTTPSを使用しなければならない
- REQ-408: システムは時計の表示遅延を±1秒以内に抑えなければならない
- REQ-409: システムは72時間以上の連続稼働に耐えなければならない
- REQ-410: システムは日本語フォント（Noto Sans CJKまたは同等）を使用しなければならない

## 非機能要件

### パフォーマンス

- NFR-001: 描画更新は時計を毎秒、日付とカレンダーを毎分、天気を取得時のみ実行し、CPU負荷を最小化する
- NFR-002: FPSは30に設定し、必要最小限の描画更新で動作する
- NFR-003: キャラクター有効時でもCPU使用率45%未満、メモリ使用量220MB未満を維持する
- NFR-004: 天気API通信のタイムアウトは10秒以内とする
- NFR-005: 背景画像のスケーリングは負荷に応じてsmoothscaleまたは通常scaleを選択可能とする

### セキュリティ

- NFR-101: APIキーは.envファイルまたはroot権限の設定ファイルで管理する
- NFR-102: 外部API通信時はSSL証明書の検証を必須とする
- NFR-103: ログにAPIキーや認証情報を出力してはならない
- NFR-104: systemdサービスはpiユーザー権限で実行する

### ユーザビリティ

- NFR-201: 時計は画面上部中央に130px程度の大きなフォントで表示する
- NFR-202: カレンダーは右下に約420×280pxのサイズで表示する
- NFR-203: 天気情報は左下に約420×280pxの角丸パネル内に表示する
- NFR-204: 全ての日本語テキストは適切に表示される
- NFR-205: 設定ファイルはYAML形式で人間が読み書きしやすい構造とする
- NFR-206: 画面マージンは左右24px、上下16pxを確保する

### 可用性

- NFR-301: 電源断からの復帰時に自動的にアプリケーションが起動する
- NFR-302: ネットワーク断絶時も時計とカレンダーは正常に動作を継続する
- NFR-303: 連続稼働72時間以上でメモリリークやクラッシュが発生しない
- NFR-304: 設定ファイルが不正な場合もデフォルト値で起動する

### 保守性

- NFR-401: 天気プロバイダは抽象クラスを実装し、容易に差し替え可能な設計とする
- NFR-402: ログはINFO/ERRORレベルで標準出力（journald）に出力する
- NFR-403: systemctl statusとjournalctlコマンドで状態監視が可能とする
- NFR-404: 各種アセット（フォント、アイコン、背景画像）は外部ファイルとして差し替え可能とする

## Edgeケース

### エラー処理

- EDGE-001: 天気API接続がタイムアウトした場合、エラーログを記録し、次回更新タイミングまで待機する
- EDGE-002: 設定ファイルが存在しない場合、デフォルト設定で起動し、警告ログを出力する
- EDGE-003: フォントファイルが読み込めない場合、システムデフォルトフォントで動作を継続する
- EDGE-004: 背景画像が読み込めない場合、黒背景で動作を継続する
- EDGE-005: スプライト画像が読み込めない場合、キャラクター表示を無効化して継続する
- EDGE-006: メモリ不足が発生した場合、systemdによる自動再起動で復旧する
- EDGE-007: 天気APIから不正なレスポンスが返された場合、エラーログを記録し、キャッシュデータを使用する

### 境界値

- EDGE-101: 月末から月初への日付変更時、カレンダーが正しく更新される
- EDGE-102: 年末から年始への日付変更時、年表示が正しく更新される
- EDGE-103: wallpapersディレクトリが空の場合、黒背景で動作する
- EDGE-104: wallpapersディレクトリに100枚以上の画像がある場合、先頭の画像のみを使用する
- EDGE-105: 天気予報データが3日分未満の場合、取得できた分のみ表示する
- EDGE-106: フォントサイズが画面に収まらない場合、自動的にスケーリングする
- EDGE-107: 2月のカレンダーが4週分しかない場合、6週グリッドの残りを空白で表示する

### 異常系

- EDGE-201: NTPサーバーと同期できない場合、システムローカル時刻を使用する
- EDGE-202: SDLドライバが初期化できない場合、エラーメッセージを出力して終了する
- EDGE-203: 必要なPythonライブラリがインストールされていない場合、エラーメッセージを出力して終了する
- EDGE-204: ディスプレイが接続されていない場合、ヘッドレスモードでも起動を試みる

## 受け入れ基準

### 機能テスト

- [ ] 電源投入から10秒以内にフルスクリーン表示が開始される
- [ ] 時計が毎秒更新され、実時刻との差が±1秒以内である
- [ ] 日付が毎分更新され、日付変更が正しく反映される
- [ ] カレンダーが日曜始まりで表示され、曜日ごとの色分けが正しい
- [ ] 月が変わった際にカレンダーが自動更新される
- [ ] 天気情報が30分ごとに更新される（ネットワーク接続時）
- [ ] ネットワーク切断時に天気情報がキャッシュから表示される
- [ ] 背景画像がfit/scaleモードで正しく表示される
- [ ] マウスカーソルが非表示になっている
- [ ] settings.yamlの変更が再起動後に反映される
- [ ] 2Dキャラクターが有効時に正しくアニメーション表示される（オプション）
- [ ] systemdサービスとして自動起動する
- [ ] 異常終了時に自動再起動される

### 非機能テスト

- [ ] CPU使用率が平均30%未満（キャラクター無効時）
- [ ] メモリ使用量が180MB以下（キャラクター無効時）
- [ ] 72時間連続稼働でクラッシュやメモリリークが発生しない
- [ ] 天気API通信がHTTPSで実行される
- [ ] APIキーがログに出力されない
- [ ] エラー発生時に適切なログが記録される
- [ ] 設定ファイル不正時もデフォルト値で起動する
- [ ] フォント/画像読み込み失敗時も動作を継続する

### 統合テスト

- [ ] Open-Meteo APIからの天気情報取得と表示が正常動作する
- [ ] Yahoo天気API使用時にクレジット表記が表示される（設定時）
- [ ] wallpapersディレクトリへの画像追加が自動検出される
- [ ] journalctlでログ監視が可能である
- [ ] systemctl statusでサービス状態が確認できる

## 要件数サマリ

- **通常要件**: 10件
- **条件付き要件**: 10件  
- **状態要件**: 4件
- **オプション要件**: 6件
- **制約要件**: 10件
- **非機能要件**: 20件
- **Edgeケース**: 18件
- **受け入れ基準**: 23項目

合計: 101件の要件定義

---

*このドキュメントはEARS（Easy Approach to Requirements Syntax）記法に基づいて作成されました。*
*作成日: 2025-08-10*