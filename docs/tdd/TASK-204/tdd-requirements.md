# TASK-204: 背景画像レンダラー実装 - 要件定義

## 概要

PiCalendar表示システムの背景画像表示機能を実装する。壁紙ディレクトリから画像を選択し、適切なスケーリングで1024×600解像度に描画するレンダラーコンポーネント。

## 基本要件

### 1. 画像読み込み仕様
- **対象ディレクトリ**: `wallpapers/` （設定可能）
- **対応形式**: JPG, PNG, BMP, GIF（静止画のみ）
- **選択方式**: ディレクトリ内の最初の対応画像（アルファベット順）
- **定期再スキャン**: 300秒間隔（設定可能）で新規画像検出

### 2. スケーリング仕様
- **モード**: fit（レターボックス）またはscale（全画面拡張）
- **fit モード**: アスペクト比維持、黒帯埋め、中央配置
- **scale モード**: 全画面に拡張、アスペクト比変更あり
- **デフォルト**: fitモード
- **解像度**: 1024×600固定

### 3. 描画優先度
- **レイヤー**: 最背面（他の全レンダラーより後ろ）
- **更新頻度**: 画像変更時のみ（定期再スキャン）
- **パフォーマンス**: キャッシュ機能で同一画像の再読み込み回避

### 4. エラーハンドリング
- **画像なし**: 単色背景（設定可能、デフォルト黒）
- **読み込み失敗**: ログ出力後、単色背景
- **フォーマット未対応**: 次の画像を試行、全て失敗で単色背景
- **ディレクトリなし**: 作成せずログ警告、単色背景

## 技術要件

### 1. アーキテクチャ
- **継承**: 他Rendererと同一設計パターン
- **AssetManager統合**: 画像キャッシュ管理
- **設定管理**: YAML設定による外部化
- **pygame統合**: Surface描画システム

### 2. 設定項目
```yaml
background:
  dir: "./wallpapers"          # 画像ディレクトリ
  mode: "fit"                  # fit|scale
  rescan_sec: 300              # 再スキャン間隔（秒）
  fallback_color: [0, 0, 0]    # 単色背景色（RGB）
  supported_formats:            # 対応画像形式
    - "jpg"
    - "jpeg" 
    - "png"
    - "bmp"
    - "gif"

ui:
  screen_width: 1024           # 画面幅
  screen_height: 600           # 画面高さ
```

### 3. パフォーマンス要件
- **読み込み時間**: 初回3秒以内、キャッシュ時0.1秒以内
- **メモリ使用**: 画像1枚分+キャッシュ、最大10MB
- **CPU負荷**: 読み込み時のみ、通常時は0%
- **ディスクアクセス**: 再スキャン時のみ

## 機能仕様

### 1. 画像検索・選択機能
- **ディレクトリスキャン**: 指定パス配下の対応ファイル検索
- **ファイルソート**: アルファベット順（自然順序）
- **拡張子判定**: 大文字小文字不問
- **最初の有効画像**: 読み込み可能な最初のファイルを選択

### 2. 画像処理機能
- **読み込み**: pygame.image.load()使用
- **スケーリング**: pygame.transform.scale()使用
- **アスペクト比計算**: fit/scaleモード別の座標・サイズ計算
- **中央配置**: fitモードでの黒帯領域計算

### 3. キャッシュ機能
- **ファイル名キャッシュ**: 前回選択画像の記録
- **サーフェスキャッシュ**: スケール済み画像の保持
- **変更検知**: ファイル更新時刻・サイズによる判定
- **メモリ管理**: 不要キャッシュの自動削除

### 4. 定期更新機能
- **スケジューリング**: 最後スキャン時刻の記録
- **条件判定**: 設定間隔経過時の再スキャン
- **変更検知**: 新規ファイル・削除ファイルの検出
- **自動適用**: 変更時の自動再読み込み

## インターフェース仕様

### 1. クラス設計
```python
class BackgroundImageRenderer:
    """背景画像レンダラークラス"""
    
    def __init__(self, asset_manager: AssetManager, settings: Dict[str, Any])
    def update(self) -> None  # 定期スキャン・画像更新
    def render(self, surface: pygame.Surface) -> None  # 背景描画
    def get_current_image_path(self) -> Optional[str]  # 現在画像パス
    def set_wallpaper_directory(self, path: str) -> None  # ディレクトリ変更
    def set_scale_mode(self, mode: str) -> None  # スケールモード変更
    def force_rescan(self) -> None  # 強制再スキャン
    def cleanup(self) -> None  # リソースクリーンアップ
```

### 2. 主要メソッド
- **_scan_wallpaper_directory()**: ディレクトリスキャン実行
- **_select_best_image()**: 最適画像の選択
- **_load_and_scale_image()**: 画像読み込み・スケーリング
- **_calculate_fit_dimensions()**: fitモード座標計算
- **_calculate_scale_dimensions()**: scaleモード座標計算
- **_should_rescan()**: 再スキャン要否判定

### 3. 設定・ユーティリティ
- **_is_supported_format()**: 対応形式判定
- **_get_natural_sort_key()**: 自然順序ソート
- **_clear_cache()**: キャッシュクリア
- **_get_fallback_surface()**: 単色背景生成

## 受け入れ基準

### ✅ 基本動作確認
- [ ] 壁紙ディレクトリから画像が正しく読み込まれる
- [ ] fit/scaleモードで適切にスケーリングされる
- [ ] 1024×600解像度に正確に描画される
- [ ] 画像なしでも単色背景で正常動作する

### ✅ 画像処理確認
- [ ] JPG、PNG、BMP形式の画像が読み込める
- [ ] アスペクト比が正しく処理される
- [ ] fitモードで黒帯が適切に配置される
- [ ] scaleモードで全画面に拡張される

### ✅ 更新・監視確認
- [ ] 定期再スキャンが設定間隔で実行される
- [ ] 新規画像追加時に自動検出される
- [ ] 画像削除時に次の画像に切り替わる
- [ ] 設定変更が即座に反映される

### ✅ パフォーマンス確認
- [ ] 初回読み込みが3秒以内で完了する
- [ ] 同一画像のキャッシュが有効である
- [ ] メモリ使用量が10MB以内に収まる
- [ ] CPU使用率が読み込み以外で0%に近い

### ✅ エラー処理確認
- [ ] ディレクトリなしでもクラッシュしない
- [ ] 読み込み失敗ファイルをスキップする
- [ ] 全画像読み込み失敗で単色背景になる
- [ ] 設定ファイル不正でもデフォルト動作する

## リスク・制約事項

### 技術的リスク
- **メモリ制約**: Pi Zero 2Wでの大画像処理
- **I/O負荷**: 定期スキャンによるディスク負荷
- **画像形式**: pygame対応外の形式混入

### 設計制約
- **単一画像**: 複数画像の同時表示は非対応
- **静止画のみ**: 動画・アニメーションGIFは非対応
- **固定解像度**: 1024×600以外は非対応

### パフォーマンス制約
- **読み込み時間**: 大画像での処理時間増大
- **メモリ使用**: 高解像度画像でのメモリ消費
- **ディスクI/O**: 頻繁な再スキャンによる負荷

## 今後の拡張計画

### Phase 1: 基本実装（本タスク）
- 単一画像表示
- fit/scaleスケーリング
- 定期再スキャン

### Phase 2: 機能拡張
- 画像ローテーション（時刻・条件別）
- フィルタ効果（明度・コントラスト調整）
- プレビュー機能

### Phase 3: 高度な機能
- 動的壁紙変更API
- 外部連携（天気・時刻連動）
- パフォーマンス監視・調整

## 実装優先度

### Priority 1 (Critical)
- 基本画像読み込み・表示機能
- fit/scaleスケーリング機能
- エラーハンドリング

### Priority 2 (Important)  
- 定期再スキャン機能
- キャッシュシステム
- 設定変更対応

### Priority 3 (Nice to have)
- パフォーマンス最適化
- 詳細ログ出力
- 拡張画像形式対応

この要件定義に基づいて、安定で効率的なBackgroundImageRendererを実装する。