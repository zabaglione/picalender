# TASK-204: 背景画像レンダラー実装 - テストケース設計

## テスト戦略概要

BackgroundImageRendererクラスの包括的なテストケースを設計する。画像読み込み、スケーリング、定期更新、キャッシュ、パフォーマンス、統合テストを含み、既存のレンダラーシステムとの整合性も検証する。

## テストカテゴリ

### 1. 基本機能テスト (Basic Functionality Tests)

#### Test Case 1.1: BackgroundImageRenderer初期化
- **目的**: BackgroundImageRendererが正しく初期化されること
- **前提条件**: AssetManagerとsettingsが正常
- **テストステップ**:
  1. AssetManagerインスタンスを作成
  2. 設定辞書を準備
  3. BackgroundImageRendererを初期化
- **期待結果**: エラーなく初期化完了、デフォルト設定適用

#### Test Case 1.2: 設定値読み込み
- **目的**: YAML設定から正しく値が読み込まれること
- **前提条件**: 設定辞書準備済み
- **テストステップ**:
  1. 各種設定値（dir, mode, rescan_sec等）を設定
  2. 初期化実行
  3. 内部設定値を確認
- **期待結果**: 設定値が正確に反映される

#### Test Case 1.3: デフォルト値適用
- **目的**: 設定不備時にデフォルト値が適用されること
- **前提条件**: 不完全な設定辞書
- **テストステップ**:
  1. 空または不完全な設定で初期化
  2. 各設定値を確認
- **期待結果**: デフォルト値で正常動作

### 2. 画像検索・読み込みテスト (Image Loading Tests)

#### Test Case 2.1: ディレクトリスキャン
- **目的**: 指定ディレクトリから画像ファイルが検出されること
- **前提条件**: テスト用画像ファイル準備
- **テストステップ**:
  1. テスト用wallpapersディレクトリ作成
  2. JPG, PNG, BMP画像を配置
  3. _scan_wallpaper_directory()実行
- **期待結果**: 対応形式のファイルリストが取得される

#### Test Case 2.2: 対応形式判定
- **目的**: 対応画像形式が正しく判定されること
- **前提条件**: 各種形式のファイル
- **テストステップ**:
  1. JPG, PNG, BMP, 非対応形式のファイル準備
  2. _is_supported_format()で各ファイル判定
- **期待結果**: 対応形式のみTrueが返される

#### Test Case 2.3: 画像選択
- **目的**: アルファベット順で最初の有効画像が選択されること
- **前提条件**: 複数画像ファイル
- **テストステップ**:
  1. 複数画像を異なる名前で配置
  2. _select_best_image()実行
  3. 選択された画像を確認
- **期待結果**: アルファベット順最初の画像が選択

#### Test Case 2.4: 画像読み込み
- **目的**: 選択された画像が正常に読み込まれること
- **前提条件**: 有効な画像ファイル
- **テストステップ**:
  1. テスト画像でload処理実行
  2. pygame.Surfaceの取得確認
  3. サイズ・形式の確認
- **期待結果**: 正常なSurfaceオブジェクト取得

### 3. スケーリング・描画テスト (Scaling & Rendering Tests)

#### Test Case 3.1: fitモードスケーリング
- **目的**: fitモードで適切にスケーリングされること
- **前提条件**: 様々なアスペクト比の画像
- **テストステップ**:
  1. 横長・縦長・正方形画像でテスト
  2. fitモード設定で_calculate_fit_dimensions()実行
  3. 計算結果を確認
- **期待結果**: アスペクト比維持、中央配置、黒帯適切

#### Test Case 3.2: scaleモードスケーリング
- **目的**: scaleモードで全画面拡張されること
- **前提条件**: 異なるサイズの画像
- **テストステップ**:
  1. 各種サイズ画像でテスト
  2. scaleモード設定で_calculate_scale_dimensions()実行
  3. 結果サイズを確認
- **期待結果**: 1024×600に正確に拡張

#### Test Case 3.3: 基本描画
- **目的**: render()メソッドが正常に描画すること
- **前提条件**: 読み込み済み画像
- **テストステップ**:
  1. pygame.Surfaceを作成
  2. render()メソッド呼び出し
  3. 描画完了確認
- **期待結果**: サーフェスに背景画像が描画される

#### Test Case 3.4: 単色背景描画
- **目的**: 画像なし時に単色背景が描画されること
- **前提条件**: 画像ファイルなし
- **テストステップ**:
  1. 空のwallpapersディレクトリ
  2. render()実行
  3. 単色背景描画確認
- **期待結果**: 設定色の単色背景が描画

### 4. 定期更新・監視テスト (Update & Monitoring Tests)

#### Test Case 4.1: 再スキャン判定
- **目的**: _should_rescan()が正しく判定すること
- **前提条件**: 時刻制御のモック
- **テストステップ**:
  1. 初回スキャン実行
  2. 時刻を進めて再判定
  3. 設定間隔経過前後で確認
- **期待結果**: 設定間隔経過時のみTrueを返す

#### Test Case 4.2: 定期更新実行
- **目的**: update()で定期的に再スキャンされること
- **前提条件**: 時刻制御のモック
- **テストステップ**:
  1. 初期状態でupdate()実行
  2. 時刻を進めて再度update()
  3. スキャン実行状況確認
- **期待結果**: 設定間隔で自動再スキャン

#### Test Case 4.3: 画像変更検知
- **目的**: 新規画像追加時に自動検知されること
- **前提条件**: 動的なファイル操作
- **テストステップ**:
  1. 初期状態で1つの画像
  2. 新しい画像を追加
  3. update()で変更検知
- **期待結果**: 新規画像に自動切り替え

#### Test Case 4.4: 強制再スキャン
- **目的**: force_rescan()で即座に更新されること
- **前提条件**: キャッシュされた状態
- **テストステップ**:
  1. 初期画像でキャッシュ状態
  2. 画像を変更
  3. force_rescan()実行
- **期待結果**: 即座に新画像に更新

### 5. キャッシュ・パフォーマンステスト (Cache & Performance Tests)

#### Test Case 5.1: 画像キャッシュ
- **目的**: 同一画像の再読み込みが回避されること
- **前提条件**: 読み込み済み画像
- **テストステップ**:
  1. 画像を初回読み込み
  2. 同じ画像で再度読み込み
  3. キャッシュヒット確認
- **期待結果**: 2回目は高速で完了

#### Test Case 5.2: キャッシュ無効化
- **目的**: 画像変更時にキャッシュが無効化されること
- **前提条件**: キャッシュ済み画像
- **テストステップ**:
  1. 画像ファイルを更新
  2. 次回読み込み時の動作確認
- **期待結果**: 新しい画像が読み込まれる

#### Test Case 5.3: メモリ使用量
- **目的**: メモリ使用量が制限内に収まること
- **前提条件**: 大容量画像
- **テストステップ**:
  1. 高解像度画像で読み込み
  2. メモリ使用量測定
  3. 制限値との比較
- **期待結果**: 10MB以内のメモリ使用

#### Test Case 5.4: 読み込み性能
- **目的**: 画像読み込み時間が基準内であること
- **前提条件**: 標準的なサイズの画像
- **テストステップ**:
  1. 画像読み込み時間測定
  2. 初回・キャッシュ時の比較
- **期待結果**: 初回3秒以内、キャッシュ0.1秒以内

### 6. 設定変更・カスタマイズテスト (Configuration Tests)

#### Test Case 6.1: ディレクトリ変更
- **目的**: set_wallpaper_directory()でディレクトリが変更されること
- **前提条件**: 複数のディレクトリ
- **テストステップ**:
  1. 初期ディレクトリで画像読み込み
  2. 別ディレクトリに変更
  3. 画像切り替え確認
- **期待結果**: 新ディレクトリの画像に切り替え

#### Test Case 6.2: スケールモード変更
- **目的**: set_scale_mode()でモードが変更されること
- **前提条件**: 読み込み済み画像
- **テストステップ**:
  1. fitモードで描画
  2. scaleモードに変更
  3. 描画結果の違い確認
- **期待結果**: モード変更が即座に反映

#### Test Case 6.3: 再スキャン間隔変更
- **目的**: 再スキャン間隔の動的変更が可能なこと
- **前提条件**: 初期設定済み
- **テストステップ**:
  1. デフォルト300秒設定
  2. 60秒に変更
  3. 間隔動作確認
- **期待結果**: 新間隔で再スキャン実行

### 7. エラーハンドリングテスト (Error Handling Tests)

#### Test Case 7.1: ディレクトリなし
- **目的**: 存在しないディレクトリでもクラッシュしないこと
- **前提条件**: 無効なディレクトリパス
- **テストステップ**:
  1. 存在しないパスを設定
  2. 初期化・スキャン実行
  3. エラー処理確認
- **期待結果**: ログ出力後、単色背景で動作

#### Test Case 7.2: 読み込み失敗
- **目的**: 破損画像ファイルをスキップすること
- **前提条件**: 正常画像と破損ファイル
- **テストステップ**:
  1. 破損ファイルを含むディレクトリ
  2. 読み込み処理実行
  3. スキップ動作確認
- **期待結果**: 破損ファイルをスキップし正常画像を選択

#### Test Case 7.3: 全画像読み込み失敗
- **目的**: 全ファイル読み込み失敗時の単色背景動作
- **前提条件**: 全て破損または非対応ファイル
- **テストステップ**:
  1. 非対応形式のみのディレクトリ
  2. 読み込み処理実行
- **期待結果**: 単色背景で安全に動作

#### Test Case 7.4: アクセス権限エラー
- **目的**: ディレクトリアクセス権限なしでも安全であること
- **前提条件**: アクセス権限制限
- **テストステップ**:
  1. 読み込み権限のないディレクトリ
  2. スキャン実行
  3. エラー処理確認
- **期待結果**: 権限エラーログ出力後、単色背景

### 8. 統合テスト (Integration Tests)

#### Test Case 8.1: AssetManager統合
- **目的**: AssetManagerとの連携が正常なこと
- **前提条件**: AssetManager初期化済み
- **テストステップ**:
  1. AssetManager経由での画像管理
  2. キャッシュ共有確認
  3. メモリ管理統合
- **期待結果**: 正常にリソース管理される

#### Test Case 8.2: 他Rendererとの描画順序
- **目的**: 背景として最背面に描画されること
- **前提条件**: 他Rendererと同時描画
- **テストステップ**:
  1. Clock・Date・Calendar・Background同時描画
  2. レイヤー順序確認
  3. 重複描画確認
- **期待結果**: 背景が最背面で他を遮らない

#### Test Case 8.3: 設定システム統合
- **目的**: YAML設定システムとの統合が正常
- **前提条件**: 設定ファイル準備済み
- **テストステップ**:
  1. settings.yamlから設定読み込み
  2. 設定変更の動的反映
  3. 不正設定時の処理
- **期待結果**: 設定値が正確に反映される

#### Test Case 8.4: 全体システム統合
- **目的**: PiCalenderシステム全体での正常動作
- **前提条件**: 統合環境準備
- **テストステップ**:
  1. 全レンダラー同時動作
  2. 長時間動作テスト
  3. リソース競合確認
- **期待結果**: システム全体で安定動作

## エッジケーステスト

### Edge Case 1: 極端なアスペクト比
- 非常に横長（21:9）や縦長（9:21）画像での処理

### Edge Case 2: 巨大画像ファイル
- 10MB超の高解像度画像での読み込み・処理

### Edge Case 3: ファイル同時アクセス
- 画像読み込み中の他プロセスによるファイル操作

### Edge Case 4: ディスク容量不足
- キャッシュ作成時のディスク容量不足

### Edge Case 5: 特殊ファイル名
- Unicode文字、空白、特殊記号を含むファイル名

## テストデータ

### 画像テストデータ
```python
test_images = [
    # 通常画像
    {"name": "landscape_1920x1080.jpg", "size": (1920, 1080), "format": "JPEG"},
    {"name": "portrait_1080x1920.png", "size": (1080, 1920), "format": "PNG"},
    {"name": "square_1000x1000.bmp", "size": (1000, 1000), "format": "BMP"},
    
    # 特殊サイズ
    {"name": "ultrawide_3440x1440.jpg", "size": (3440, 1440), "format": "JPEG"},
    {"name": "small_640x480.png", "size": (640, 480), "format": "PNG"},
    
    # エラー用
    {"name": "corrupted.jpg", "size": None, "format": "INVALID"},
    {"name": "unsupported.tiff", "size": (1000, 1000), "format": "TIFF"},
]
```

### 設定テストデータ
```python
test_settings = [
    # デフォルト設定
    {
        "background": {
            "dir": "./wallpapers",
            "mode": "fit", 
            "rescan_sec": 300,
            "fallback_color": [0, 0, 0]
        }
    },
    
    # カスタム設定
    {
        "background": {
            "dir": "./custom_images",
            "mode": "scale",
            "rescan_sec": 60,
            "fallback_color": [32, 32, 32]
        }
    },
    
    # 不完全設定
    {
        "background": {
            "dir": "./missing_dir"
            # 他の設定不備
        }
    }
]
```

### パフォーマンステストデータ
```python
performance_scenarios = [
    {"image_count": 1, "image_size": "1MB", "expected_load_time": 1.0},
    {"image_count": 10, "image_size": "500KB", "expected_scan_time": 0.5},
    {"image_count": 100, "image_size": "100KB", "expected_scan_time": 2.0},
]
```

## 実装優先度

### Priority 1 (Critical) - 18テストケース
- Test Case 1.1, 1.2, 1.3 (基本機能)
- Test Case 2.1, 2.2, 2.3, 2.4 (画像読み込み)
- Test Case 3.1, 3.2, 3.3, 3.4 (スケーリング・描画)
- Test Case 4.1, 4.2 (基本更新)
- Test Case 7.1, 7.2, 7.3 (基本エラー処理)
- Test Case 8.4 (統合基本)

### Priority 2 (Important) - 10テストケース  
- Test Case 4.3, 4.4 (高度な更新)
- Test Case 5.1, 5.2 (キャッシュ基本)
- Test Case 6.1, 6.2 (設定変更)
- Test Case 7.4 (権限エラー)
- Test Case 8.1, 8.2, 8.3 (統合拡張)

### Priority 3 (Nice to have) - 6テストケース
- Test Case 5.3, 5.4 (パフォーマンス)
- Test Case 6.3 (設定変更拡張)
- Edge Caseテスト群

## テスト実装計画

1. **フェーズ1**: 基本機能テスト実装（画像読み込み・描画）
2. **フェーズ2**: スケーリング・更新テスト実装  
3. **フェーズ3**: 統合・パフォーマンステスト実装

各フェーズでRed-Green-Refactorサイクルを実行し、継続的に品質を確保する。

**合計テストケース数**: 34ケース
**実装目標カバレッジ**: 95%以上
**実行時間目標**: 全テスト45秒以内