# TASK-203: カレンダーレンダラー実装 - 要件定義

## 概要

PiCalendar表示システムの今月カレンダー表示機能を実装する。時計・日付表示と連携し、一貫した日付情報を提供するレンダラーコンポーネント。

## 基本要件

### 1. カレンダー表示仕様
- **表示対象**: 現在月のカレンダー
- **開始曜日**: 日曜始まり（設定変更可能）
- **週数表示**: 最大6週分（カレンダー月により変動）
- **表示領域**: 約420×280px
- **配置位置**: 画面右下（設定座標基準）

### 2. 日付表示要件
- **今日ハイライト**: 現在日を視覚的に強調
- **曜日ヘッダ**: Sun, Mon, Tue, Wed, Thu, Fri, Sat
- **日付配色**: 
  - 日曜日: 赤系 (#FF6B6B)
  - 土曜日: 青系 (#4DABF7) 
  - 平日: 白系 (#FFFFFF)
  - 今日: 強調色背景 (#FFD93D)

### 3. フォント・サイズ仕様
- **曜日ヘッダフォント**: 22px、太字
- **日付フォント**: 22px、通常
- **セル間隔**: 4px margin
- **セルサイズ**: 自動計算（約50×35px想定）

### 4. 更新・動作要件
- **更新頻度**: 毎分1回（日付変更検知）
- **月切り替え**: 月が変わった際の自動更新
- **レスポンシブ**: 画面サイズに対する適切な配置
- **キャッシュ**: 同月内での再レンダリング抑制

## 技術要件

### 1. アーキテクチャ
- **継承**: ClockRenderer、DateRendererと同一設計パターン
- **AssetManager統合**: フォント管理の一元化
- **設定管理**: YAML設定による外部化
- **pygame描画**: Surface・Rect による効率的描画

### 2. 設定項目
```yaml
ui:
  calendar_font_px: 22
  calendar_header_font_px: 22
  calendar_position_x: 580  # 右下配置
  calendar_position_y: 300
  calendar_width: 420
  calendar_height: 280
  calendar_cell_margin: 4

calendar:
  first_weekday: "SUNDAY"  # SUNDAY|MONDAY
  today_highlight: true
  color_sunday: [255, 107, 107]    # #FF6B6B
  color_saturday: [77, 171, 247]   # #4DABF7  
  color_weekday: [255, 255, 255]   # #FFFFFF
  color_today_bg: [255, 217, 61]   # #FFD93D
  color_today_text: [0, 0, 0]      # #000000
  color_header: [200, 200, 200]    # #C8C8C8
```

### 3. パフォーマンス要件
- **描画時間**: 1回あたり2ms以下
- **メモリ使用**: カレンダーデータ構造最適化
- **CPU負荷**: 平均2%以下（Pi Zero 2W基準）
- **キャッシュ効率**: 月内90%キャッシュヒット

## 機能仕様

### 1. カレンダー生成機能
- **月情報取得**: datetime.now()から現在月を特定
- **週構造生成**: calendar.monthcalendar()による週配列取得
- **日曜始まり調整**: calendar.setfirstweekday()による開始曜日設定
- **空日処理**: 前月・翌月日付の適切な空白処理

### 2. 描画システム
- **ヘッダ描画**: 曜日名の横一列配置
- **日付セル描画**: 6週×7日のグリッド描画
- **色分け処理**: 曜日別・今日ハイライトの色設定
- **位置計算**: 各セルの座標自動計算

### 3. 更新管理
- **変更検知**: 現在月の変更を検知
- **部分更新**: 今日日付のハイライト更新のみ
- **完全更新**: 月切り替え時の全体再描画
- **キャッシュ管理**: Surface キャッシュによる効率化

### 4. レイアウト計算
- **セルサイズ**: 全体サイズから逆算
- **グリッド配置**: 7列×7行（ヘッダ+6週）の均等配置
- **マージン計算**: セル間隔の適切な設定
- **中央揃え**: 各セル内の数字中央配置

## インターフェース仕様

### 1. クラス設計
```python
class CalendarRenderer:
    """カレンダーレンダラークラス"""
    
    def __init__(self, asset_manager: AssetManager, settings: Dict[str, Any])
    def update(self) -> None  # 月・日付変更の検知と更新
    def render(self, surface: pygame.Surface) -> None  # カレンダー描画
    def get_current_month(self) -> Tuple[int, int]  # (年, 月)
    def set_first_weekday(self, weekday: str) -> None  # 開始曜日変更
    def set_position(self, x: int, y: int) -> None  # 配置位置変更
    def cleanup(self) -> None  # リソースクリーンアップ
```

### 2. 主要メソッド
- **_generate_calendar_data()**: 月カレンダーデータ生成
- **_calculate_cell_positions()**: セル座標計算
- **_render_header()**: 曜日ヘッダ描画
- **_render_date_cells()**: 日付セル群描画
- **_get_cell_color()**: 曜日・今日による色決定
- **_is_today()**: 今日判定ロジック

### 3. 設定メソッド
- **set_colors()**: 色設定の動的変更
- **set_font_sizes()**: フォントサイズ変更
- **set_layout()**: レイアウトパラメータ変更
- **_validate_settings()**: 設定値バリデーション

## 受け入れ基準

### ✅ 基本動作確認
- [ ] 現在月のカレンダーが正確に表示される
- [ ] 日曜始まりのレイアウトで表示される
- [ ] 今日の日付が適切にハイライトされる
- [ ] 曜日別の色分けが正しく適用される

### ✅ レイアウト確認
- [ ] 420×280pxの指定領域内に収まる
- [ ] 7×7グリッドが均等に配置される
- [ ] セル間マージンが適切に設定される
- [ ] 文字が各セルの中央に配置される

### ✅ 動作確認
- [ ] 月が変わった際に自動更新される
- [ ] 日付が変わった際に今日ハイライトが更新される
- [ ] 設定変更が即座に反映される
- [ ] エラー状態でも安全に動作する

### ✅ パフォーマンス確認
- [ ] 1回の描画が2ms以下で完了する
- [ ] 同月内でのキャッシュ効果が確認できる
- [ ] 1000回描画テストで安定動作する
- [ ] メモリリークが発生しない

### ✅ 統合確認
- [ ] AssetManagerとの連携が正常動作する
- [ ] 設定ファイルからの値読み込みが正常
- [ ] ClockRenderer、DateRendererとの画面配置が適切
- [ ] 全体システムでの動作に影響しない

## リスク・制約事項

### 技術的リスク
- **カレンダーライブラリ**: Python calendar モジュールの挙動差異
- **フォント描画**: 小さなフォントサイズでの可読性
- **メモリ制約**: Pi Zero 2Wでの大量描画処理

### 設計制約
- **固定レイアウト**: 当面は1024×600解像度専用
- **言語固定**: 英語曜日ヘッダのみ（将来拡張予定）
- **色設定**: 設定ファイルベース（動的テーマ変更は未対応）

### パフォーマンス制約
- **描画頻度**: 毎分更新が前提
- **処理時間**: リアルタイム表示要件
- **メモリ**: 他コンポーネントとの共存

## 今後の拡張計画

### Phase 1: 基本実装（本タスク）
- 現在月カレンダー表示
- 基本的な色分け・ハイライト
- AssetManager統合

### Phase 2: 機能拡張
- 祝日表示対応
- 月表示切り替え（前月・翌月）
- 複数言語曜日ヘッダ

### Phase 3: 高度な機能
- イベント・予定表示
- カレンダー外部連携（ICS等）
- 動的テーマ・色変更

## 実装優先度

### Priority 1 (Critical)
- カレンダー基本表示機能
- 今日ハイライト
- 曜日色分け

### Priority 2 (Important)  
- キャッシュ機能
- 月切り替え検知
- パフォーマンス最適化

### Priority 3 (Nice to have)
- 設定動的変更
- エラーハンドリング強化
- 詳細ログ出力

この要件定義に基づいて、堅牢で効率的なCalendarRendererを実装する。