# TASK-203: カレンダーレンダラー実装 - テストケース設計

## テスト戦略概要

CalendarRendererクラスの包括的なテストケースを設計する。カレンダー生成、描画、レイアウト、パフォーマンス、統合テストを含み、既存のClockRenderer・DateRendererとの整合性も検証する。

## テストカテゴリ

### 1. 基本機能テスト (Basic Functionality Tests)

#### Test Case 1.1: CalendarRenderer初期化
- **目的**: CalendarRendererが正しく初期化されること
- **前提条件**: AssetManagerとsettingsが正常
- **テストステップ**:
  1. AssetManagerインスタンスを作成
  2. 設定辞書を準備
  3. CalendarRendererを初期化
- **期待結果**: エラーなく初期化完了、デフォルト設定適用

#### Test Case 1.2: 現在月取得
- **目的**: get_current_month()が正しい年月を返すこと
- **前提条件**: CalendarRendererが初期化済み
- **テストステップ**:
  1. get_current_month()を呼び出し
  2. 戻り値の形式を確認
- **期待結果**: (年, 月)のタプル形式

#### Test Case 1.3: カレンダーデータ生成
- **目的**: _generate_calendar_data()が正確な月構造を生成すること
- **前提条件**: 特定の年月を指定
- **テストステップ**:
  1. 2024年8月のカレンダーデータ生成
  2. 週数とデータ構造を確認
  3. 日曜始まりの配置確認
- **期待結果**: 6週×7日の正確な配列構造

#### Test Case 1.4: 今日判定機能
- **目的**: _is_today()が現在日を正確に判定すること
- **前提条件**: 固定日付でのテスト
- **テストステップ**:
  1. 今日の日付でテスト実行
  2. 昨日・明日の日付でテスト実行
  3. 別月の同日でテスト実行
- **期待結果**: 今日のみTrueを返す

### 2. レイアウト・描画テスト (Layout & Rendering Tests)

#### Test Case 2.1: セル位置計算
- **目的**: _calculate_cell_positions()が正確な座標を計算すること
- **前提条件**: 420×280px領域設定
- **テストステップ**:
  1. 7×7グリッドの座標計算
  2. セル間マージン確認
  3. 境界値での計算確認
- **期待結果**: 各セルが等間隔で配置される座標

#### Test Case 2.2: 基本描画
- **目的**: render()メソッドが正常に描画すること
- **前提条件**: pygame初期化済み
- **テストステップ**:
  1. pygame.Surfaceを作成
  2. render()メソッド呼び出し
  3. 描画完了確認
- **期待結果**: サーフェスにカレンダーが描画される

#### Test Case 2.3: ヘッダ描画
- **目的**: _render_header()が曜日ヘッダを正確に描画すること
- **前提条件**: フォント読み込み済み
- **テストステップ**:
  1. ヘッダ描画実行
  2. 7つの曜日名配置確認
  3. 日曜始まりの順序確認
- **期待結果**: "Sun, Mon, Tue, ..., Sat"の順で描画

#### Test Case 2.4: 日付セル描画
- **目的**: _render_date_cells()が日付を適切に描画すること
- **前提条件**: カレンダーデータ生成済み
- **テストステップ**:
  1. 各週の日付描画
  2. 空セル（0）の処理確認
  3. 月末日付の処理確認
- **期待結果**: 正確な日付数字がセル内に描画

### 3. 色分け・ハイライトテスト (Color & Highlight Tests)

#### Test Case 3.1: 曜日別色分け
- **目的**: _get_cell_color()が曜日に応じた色を返すこと
- **前提条件**: 色設定が準備済み
- **テストステップ**:
  1. 日曜日（0）で赤系色取得
  2. 土曜日（6）で青系色取得
  3. 平日（1-5）で白系色取得
- **期待結果**: 設定された曜日別色が返される

#### Test Case 3.2: 今日ハイライト
- **目的**: 今日の日付が適切にハイライトされること
- **前提条件**: 今日を含む月のカレンダー
- **テストステップ**:
  1. 今日の日付でハイライト色取得
  2. 背景色・文字色の確認
  3. 他の日付との違い確認
- **期待結果**: 今日のみ強調色で表示

#### Test Case 3.3: 色設定変更
- **目的**: set_colors()で動的に色が変更されること
- **前提条件**: 初期色設定で描画済み
- **テストステップ**:
  1. 新しい色設定を適用
  2. 再描画実行
  3. 色変更の反映確認
- **期待結果**: 新しい色設定で描画される

### 4. 更新・変更検知テスト (Update & Change Detection Tests)

#### Test Case 4.1: 月変更検知
- **目的**: 月が変わった際に正しく更新されること
- **前提条件**: 月末日での初期化
- **テストステップ**:
  1. 月末日でカレンダー生成
  2. 月初日に日付変更
  3. update()で変更検知
- **期待結果**: 新しい月のカレンダーに更新

#### Test Case 4.2: 日付更新
- **目的**: 日が変わった際に今日ハイライトが更新されること
- **前提条件**: 特定日での初期描画
- **テストステップ**:
  1. 前日で初期化
  2. 今日に日付変更
  3. update()でハイライト更新
- **期待結果**: 新しい今日がハイライト表示

#### Test Case 4.3: 同月内更新最適化
- **目的**: 同月内では部分更新のみ実行されること
- **前提条件**: 同月内の日付変更
- **テストステップ**:
  1. 同月の異なる日付で複数回更新
  2. 再描画回数の測定
  3. キャッシュ効果の確認
- **期待結果**: カレンダー構造は再生成されない

### 5. 設定・カスタマイズテスト (Configuration Tests)

#### Test Case 5.1: 開始曜日変更
- **目的**: set_first_weekday()で週開始が変更されること
- **前提条件**: 日曜始まりで初期化
- **テストステップ**:
  1. 月曜始まりに変更
  2. カレンダー再生成
  3. ヘッダと配置の確認
- **期待結果**: "Mon, Tue, ..., Sun"順で表示

#### Test Case 5.2: フォントサイズ設定
- **目的**: フォントサイズが設定通り適用されること
- **前提条件**: 異なるフォントサイズ設定
- **テストステップ**:
  1. ヘッダ用24pxフォント設定
  2. 日付用20pxフォント設定
  3. 描画実行とサイズ確認
- **期待結果**: 指定サイズで描画

#### Test Case 5.3: 位置設定
- **目的**: set_position()で描画位置が変更されること
- **前提条件**: デフォルト位置で描画済み
- **テストステップ**:
  1. 新しい座標を設定
  2. 再描画実行
  3. 描画位置の確認
- **期待結果**: 指定座標に描画

#### Test Case 5.4: サイズ設定
- **目的**: カレンダー領域サイズが設定可能なこと
- **前提条件**: デフォルトサイズ設定
- **テストステップ**:
  1. 500×350pxに変更
  2. セル位置再計算
  3. 新サイズでの描画
- **期待結果**: 新サイズに合わせてレイアウト調整

### 6. エラーハンドリングテスト (Error Handling Tests)

#### Test Case 6.1: フォント読み込み失敗
- **目的**: フォント読み込み失敗時のフォールバック
- **前提条件**: 無効なフォントパス設定
- **テストステップ**:
  1. 無効フォントパスで初期化
  2. フォールバック処理確認
  3. システムフォントでの描画
- **期待結果**: システムフォントで正常動作

#### Test Case 6.2: 無効な設定値処理
- **目的**: 不正な設定値での安全な動作
- **前提条件**: 無効な色・サイズ設定
- **テストステップ**:
  1. 負の値、範囲外値を設定
  2. 初期化・描画実行
  3. デフォルト値での動作確認
- **期待結果**: デフォルト値で安全に動作

#### Test Case 6.3: メモリ不足対応
- **目的**: メモリ制約下での安全な動作
- **前提条件**: 大量のサーフェス作成
- **テストステップ**:
  1. メモリ使用量の監視
  2. 限界条件での動作テスト
  3. 適切なエラー処理確認
- **期待結果**: 適切にエラー処理され停止しない

### 7. パフォーマンステスト (Performance Tests)

#### Test Case 7.1: 描画性能測定
- **目的**: 1回の描画が2ms以下で完了すること
- **前提条件**: パフォーマンス測定環境
- **テストステップ**:
  1. 1000回連続描画実行
  2. 平均実行時間測定
  3. 最大実行時間確認
- **期待結果**: 平均2ms以下、最大5ms以下

#### Test Case 7.2: メモリ使用量測定
- **目的**: メモリリーク検出とキャッシュ効率
- **前提条件**: メモリ監視環境
- **テストステップ**:
  1. 10000回更新・描画サイクル
  2. メモリ使用量変化の監視
  3. ガベージコレクション効果確認
- **期待結果**: メモリ使用量が安定

#### Test Case 7.3: キャッシュ効率測定
- **目的**: 月内でのキャッシュヒット率90%以上
- **前提条件**: キャッシュ機能実装済み
- **テストステップ**:
  1. 同月内で100回描画
  2. キャッシュヒット率測定
  3. 異なる月での比較
- **期待結果**: 同月内90%以上のキャッシュヒット

### 8. 統合テスト (Integration Tests)

#### Test Case 8.1: AssetManager統合
- **目的**: AssetManagerとの連携が正常なこと
- **前提条件**: AssetManager初期化済み
- **テストステップ**:
  1. フォント読み込み統合テスト
  2. キャッシュ共有確認
  3. 複数Rendererでの競合テスト
- **期待結果**: 正常にフォント共有される

#### Test Case 8.2: 他Rendererとの配置統合
- **目的**: ClockRenderer・DateRendererとの画面配置が適切
- **前提条件**: 他Renderer初期化済み
- **テストステップ**:
  1. 同時描画での重複確認
  2. 相対位置関係の検証
  3. 1024×600画面での全体レイアウト
- **期待結果**: 適切な位置に重複なく配置

#### Test Case 8.3: 設定システム統合
- **目的**: YAML設定システムとの統合が正常
- **前提条件**: 設定ファイル準備済み
- **テストステップ**:
  1. 設定ファイル読み込みテスト
  2. 設定変更の動的反映
  3. 設定エラー時の処理
- **期待結果**: 設定値が正確に反映される

#### Test Case 8.4: 全体ワークフロー
- **目的**: 完全なワークフローが正常動作
- **前提条件**: 統合環境準備
- **テストステップ**:
  1. 初期化→更新→描画のサイクル
  2. 月変更シナリオ実行
  3. 設定変更シナリオ実行
  4. エラー回復シナリオ実行
- **期待結果**: 全シナリオでエラーなく実行完了

## エッジケーステスト

### Edge Case 1: 月跨ぎ境界値
- 1月31日→2月1日、2月28日→3月1日の切り替え
- うるう年の2月29日処理

### Edge Case 2: 年跨ぎ
- 12月31日→1月1日の年変更処理
- 新年最初のカレンダー表示

### Edge Case 3: システム時刻変更
- 手動での時刻変更時の対応
- NTP同期による時刻修正時の処理

### Edge Case 4: 特殊な月構造
- 6週必要な月（例：2024年9月）
- 5週で済む月（例：2025年2月）

### Edge Case 5: 極端な設定値
- 極小フォント（8px）での描画
- 極大領域（1000×800px）での描画
- 極小領域（100×100px）での描画

## テストデータ

### カレンダーテストデータ
```python
test_months = [
    (2024, 1),   # 元日が月曜日
    (2024, 2),   # うるう年2月
    (2024, 8),   # 通常の31日月
    (2024, 9),   # 6週必要な月
    (2025, 2),   # 平年2月・5週で済む
    (2024, 12),  # 年末月
]
```

### 色テストデータ
```python
color_settings = {
    'default': {
        'sunday': [255, 107, 107],
        'saturday': [77, 171, 247],
        'weekday': [255, 255, 255],
        'today_bg': [255, 217, 61],
        'today_text': [0, 0, 0],
    },
    'high_contrast': {
        'sunday': [255, 0, 0],
        'saturday': [0, 0, 255],
        'weekday': [255, 255, 255],
        'today_bg': [255, 255, 0],
        'today_text': [0, 0, 0],
    }
}
```

### レイアウトテストデータ
```python
layout_settings = [
    {'width': 420, 'height': 280, 'cell_margin': 4},  # デフォルト
    {'width': 500, 'height': 350, 'cell_margin': 6},  # 大きめ
    {'width': 300, 'height': 200, 'cell_margin': 2},  # 小さめ
    {'width': 840, 'height': 560, 'cell_margin': 8},  # 倍サイズ
]
```

## 実装優先度

### Priority 1 (Critical) - 16テストケース
- Test Case 1.1, 1.2, 1.3, 1.4 (基本機能)
- Test Case 2.1, 2.2, 2.3, 2.4 (描画基本)
- Test Case 3.1, 3.2 (色分け基本)
- Test Case 4.1, 4.2 (更新基本)
- Test Case 5.1, 5.2 (設定基本)
- Test Case 8.4 (統合基本)

### Priority 2 (Important) - 10テストケース  
- Test Case 3.3 (色変更)
- Test Case 4.3 (更新最適化)
- Test Case 5.3, 5.4 (位置・サイズ)
- Test Case 6.1, 6.2 (エラー基本)
- Test Case 7.1, 7.2 (性能基本)
- Test Case 8.1, 8.2 (統合拡張)

### Priority 3 (Nice to have) - 6テストケース
- Test Case 6.3 (メモリ対応)
- Test Case 7.3 (キャッシュ効率)
- Test Case 8.3 (設定統合)
- Edge Caseテスト群

## テスト実装計画

1. **フェーズ1**: 基本機能テスト実装（カレンダー生成・描画）
2. **フェーズ2**: レイアウト・色分けテスト実装  
3. **フェーズ3**: 更新・性能・統合テスト実装

各フェーズでRed-Green-Refactorサイクルを実行し、継続的に品質を確保する。

**合計テストケース数**: 32ケース
**実装目標カバレッジ**: 95%以上
**実行時間目標**: 全テスト30秒以内