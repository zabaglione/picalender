# TASK-304: 天気スレッド管理実装 - 要件定義

## 概要

天気データを定期的に取得するバックグラウンドスレッドの管理システムを実装する。プロバイダとキャッシュを活用し、UIをブロックしない非同期更新を実現する。

## 基本要件

### 1. スレッド管理
- **専用スレッド**: 天気取得専用のバックグラウンドスレッド
- **更新間隔**: デフォルト30分（設定可能）
- **自動再試行**: エラー時の指数バックオフ
- **安全な停止**: グレースフルシャットダウン

### 2. データフロー
- **取得**: WeatherProvider経由でAPIから取得
- **キャッシュ**: WeatherCacheに保存
- **通知**: UIスレッドへのデータ通知（キュー経由）
- **エラー通知**: 取得失敗時の通知

### 3. 状態管理
- **実行状態**: 開始、停止、一時停止、再開
- **エラー状態**: 連続失敗カウント、最終成功時刻
- **統計情報**: 取得回数、成功率、平均応答時間

## 技術要件

### 1. WeatherThreadクラス

```python
class WeatherThread:
    """天気データ取得スレッド管理クラス"""
    
    def __init__(self, provider: WeatherProvider, cache: WeatherCache, settings: Dict[str, Any]):
        """初期化
        
        Args:
            provider: 天気プロバイダ
            cache: キャッシュシステム
            settings: 設定辞書
        """
        pass
    
    def start(self) -> bool:
        """スレッド開始
        
        Returns:
            開始成功の場合True
        """
        pass
    
    def stop(self, timeout: float = 5.0) -> bool:
        """スレッド停止
        
        Args:
            timeout: 停止待機タイムアウト（秒）
            
        Returns:
            正常停止の場合True
        """
        pass
    
    def pause(self) -> None:
        """一時停止"""
        pass
    
    def resume(self) -> None:
        """再開"""
        pass
    
    def force_update(self) -> bool:
        """強制更新
        
        Returns:
            更新成功の場合True
        """
        pass
    
    def get_latest_data(self) -> Optional[Dict[str, Any]]:
        """最新データ取得
        
        Returns:
            最新の天気データまたはNone
        """
        pass
    
    def get_status(self) -> Dict[str, Any]:
        """ステータス取得
        
        Returns:
            スレッド状態情報
        """
        pass
```

### 2. スレッド実行ロジック

```python
def _thread_worker(self):
    """スレッドワーカー（メインループ）"""
    while not self._stop_event.is_set():
        if not self._pause_event.is_set():
            try:
                # データ取得
                data = self._fetch_weather_data()
                
                # キャッシュ保存
                self._save_to_cache(data)
                
                # UI通知
                self._notify_update(data)
                
                # 成功カウント更新
                self._update_statistics(success=True)
                
                # 次回まで待機
                self._wait_next_update()
                
            except Exception as e:
                # エラー処理
                self._handle_error(e)
                
                # 再試行待機
                self._wait_retry()
        else:
            # 一時停止中
            time.sleep(0.1)
```

### 3. エラーハンドリング

```python
class WeatherThreadError(Exception):
    """天気スレッドエラーの基底クラス"""
    pass

class ThreadStartError(WeatherThreadError):
    """スレッド開始エラー"""
    pass

class ThreadStopError(WeatherThreadError):
    """スレッド停止エラー"""
    pass

class UpdateError(WeatherThreadError):
    """更新エラー"""
    pass
```

### 4. 設定オプション

```yaml
weather:
  thread:
    enabled: true
    update_interval: 1800  # 30分
    retry_interval: 60     # 1分（初回再試行）
    max_retries: 5
    retry_backoff: 2.0     # 指数バックオフ係数
    timeout: 30            # API呼び出しタイムアウト
    auto_start: true       # アプリ起動時に自動開始
```

## 機能仕様

### 1. 自動更新フロー
1. 設定された間隔でデータ取得を実行
2. プロバイダ経由でAPIアクセス
3. 成功時はキャッシュに保存
4. UIスレッドに通知（非ブロッキング）
5. 次回更新まで待機

### 2. エラー回復戦略
- **初回失敗**: 1分後に再試行
- **連続失敗**: 指数バックオフ（1分→2分→4分→8分→16分）
- **最大再試行**: 5回まで
- **回復時**: 通常間隔に戻る
- **キャッシュ利用**: エラー時は既存キャッシュを使用

### 3. 状態遷移
```
STOPPED → STARTING → RUNNING → STOPPING → STOPPED
                ↓        ↑
              PAUSED ────┘
```

### 4. 通知システム
- **データ更新通知**: 新規データ取得時
- **エラー通知**: 取得失敗時
- **状態変更通知**: 開始/停止/一時停止/再開
- **統計更新通知**: 定期的な統計情報更新

## パフォーマンス要件

### 1. リソース使用量
- **CPU**: アイドル時1%以下
- **メモリ**: 5MB以下
- **スレッド数**: 1（専用スレッド）
- **ネットワーク**: 更新時のみ使用

### 2. レスポンス時間
- **開始時間**: 100ms以内
- **停止時間**: 5秒以内
- **強制更新**: 即座に実行開始
- **データ取得**: 3秒以内（API依存）

## セキュリティ要件

### 1. スレッド安全性
- **排他制御**: 共有データへのアクセス制御
- **デッドロック防止**: タイムアウト付きロック
- **リソースリーク防止**: 確実なクリーンアップ
- **例外安全性**: 例外時のリソース解放

### 2. データ保護
- **APIキー保護**: ログ出力時のマスク
- **通信暗号化**: HTTPS必須
- **エラー情報**: 機密情報を含まない

## エラーハンドリング

### 1. 起動時エラー
- **既存スレッド**: 既に実行中の場合は警告
- **初期化失敗**: リソース不足等
- **設定エラー**: 必須設定の欠如

### 2. 実行時エラー
- **ネットワークエラー**: 再試行戦略適用
- **APIエラー**: エラーコードに応じた処理
- **キャッシュエラー**: ログ記録、継続動作
- **不明なエラー**: ログ記録、再試行

### 3. 停止時エラー
- **タイムアウト**: 強制終了
- **リソース解放失敗**: ログ記録
- **状態不整合**: リセット処理

## 受け入れ基準

### ✅ 基本機能
- [ ] バックグラウンドスレッドの開始・停止
- [ ] 定期的な天気データ取得
- [ ] キャッシュとの連携
- [ ] エラー時の再試行

### ✅ 状態管理
- [ ] 一時停止・再開機能
- [ ] 強制更新機能
- [ ] 状態取得API
- [ ] 統計情報の記録

### ✅ エラー処理
- [ ] ネットワークエラーの適切な処理
- [ ] 指数バックオフによる再試行
- [ ] グレースフルシャットダウン
- [ ] エラー通知

### ✅ パフォーマンス
- [ ] CPU使用率1%以下（アイドル時）
- [ ] メモリ使用量5MB以下
- [ ] 開始時間100ms以内
- [ ] 停止時間5秒以内

## 実装ファイル構成

```
src/weather/
├── thread/
│   ├── __init__.py
│   ├── weather_thread.py    # メインスレッド管理
│   └── exceptions.py        # スレッド例外クラス
```

## テスト要件

### 1. 単体テスト
- スレッドライフサイクル
- 更新ロジック
- エラーハンドリング
- 状態遷移

### 2. 統合テスト
- プロバイダとの連携
- キャッシュとの連携
- 並行実行の安全性
- 長時間実行の安定性

### 3. エッジケース
- 高頻度更新
- ネットワーク断続
- メモリ不足
- 異常終了からの回復

## 制限事項

### 1. 現在の制限
- 単一スレッドのみ
- 単一プロバイダ
- ローカル通知のみ
- 固定優先度

### 2. 将来の拡張
- 複数プロバイダ対応
- 優先度制御
- リモート通知
- 動的間隔調整

この要件定義に基づき、安定した天気データ取得スレッドシステムを実装する。