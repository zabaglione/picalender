# TASK-304: 天気スレッド管理実装 - テストケース設計

## テスト戦略概要

WeatherThreadクラスの包括的なテストケースを設計する。スレッドライフサイクル、定期更新、エラーハンドリング、状態管理を含む全機能を検証する。

## テストカテゴリ

### 1. 基本機能テスト (Basic Functionality Tests)

#### Test Case 1.1: WeatherThread初期化
- **目的**: WeatherThreadが正しく初期化されること
- **前提条件**: プロバイダ、キャッシュ、設定を準備
- **テストステップ**:
  1. モックプロバイダとキャッシュを作成
  2. WeatherThreadを初期化
  3. 初期状態確認
- **期待結果**: エラーなく初期化、STOPPED状態

#### Test Case 1.2: スレッド開始
- **目的**: start()でスレッドが開始すること
- **前提条件**: WeatherThreadインスタンス
- **テストステップ**:
  1. start()実行
  2. スレッド状態確認
  3. is_alive()確認
- **期待結果**: True返却、RUNNING状態

#### Test Case 1.3: スレッド停止
- **目的**: stop()でスレッドが停止すること
- **前提条件**: 実行中のスレッド
- **テストステップ**:
  1. スレッド開始
  2. stop()実行
  3. 停止確認
- **期待結果**: True返却、STOPPED状態

### 2. 定期更新テスト (Periodic Update Tests)

#### Test Case 2.1: 自動更新実行
- **目的**: 設定間隔で更新が実行されること
- **前提条件**: update_interval=1秒
- **テストステップ**:
  1. スレッド開始
  2. 2秒待機
  3. 更新回数確認
- **期待結果**: 2回以上の更新実行

#### Test Case 2.2: データ取得とキャッシュ保存
- **目的**: 取得データがキャッシュに保存されること
- **前提条件**: モックプロバイダとキャッシュ
- **テストステップ**:
  1. プロバイダがデータ返却設定
  2. スレッド実行
  3. キャッシュ保存確認
- **期待結果**: cache.set()が呼ばれる

#### Test Case 2.3: 最新データ取得
- **目的**: get_latest_data()で最新データ取得
- **前提条件**: 更新済みスレッド
- **テストステップ**:
  1. データ更新実行
  2. get_latest_data()呼び出し
  3. データ確認
- **期待結果**: 最新データ返却

### 3. 状態管理テスト (State Management Tests)

#### Test Case 3.1: 一時停止と再開
- **目的**: pause()/resume()が機能すること
- **前提条件**: 実行中のスレッド
- **テストステップ**:
  1. pause()実行
  2. 状態確認
  3. resume()実行
  4. 状態確認
- **期待結果**: PAUSED→RUNNING遷移

#### Test Case 3.2: 強制更新
- **目的**: force_update()で即座に更新
- **前提条件**: 実行中のスレッド
- **テストステップ**:
  1. force_update()実行
  2. 即座の更新確認
  3. データ確認
- **期待結果**: 即座に更新実行

#### Test Case 3.3: ステータス取得
- **目的**: get_status()で状態情報取得
- **前提条件**: 実行中のスレッド
- **テストステップ**:
  1. 複数回更新実行
  2. get_status()呼び出し
  3. 統計情報確認
- **期待結果**: 正確な統計情報

### 4. エラーハンドリングテスト (Error Handling Tests)

#### Test Case 4.1: ネットワークエラー時の再試行
- **目的**: エラー時に再試行が実行されること
- **前提条件**: エラーを返すプロバイダ
- **テストステップ**:
  1. NetworkError発生設定
  2. スレッド実行
  3. 再試行確認
- **期待結果**: 設定回数の再試行

#### Test Case 4.2: 指数バックオフ
- **目的**: 再試行間隔が指数的に増加
- **前提条件**: 連続エラー設定
- **テストステップ**:
  1. 連続失敗設定
  2. 再試行間隔測定
  3. バックオフ確認
- **期待結果**: 1秒→2秒→4秒→8秒

#### Test Case 4.3: エラー回復
- **目的**: エラー後に正常復帰すること
- **前提条件**: エラー後に成功する設定
- **テストステップ**:
  1. 3回失敗後成功設定
  2. スレッド実行
  3. 回復確認
- **期待結果**: 正常間隔に復帰

### 5. スレッド安全性テスト (Thread Safety Tests)

#### Test Case 5.1: 並行アクセス
- **目的**: 複数スレッドから安全にアクセス
- **前提条件**: 実行中のWeatherThread
- **テストステップ**:
  1. 複数スレッドからget_latest_data()
  2. 同時実行
  3. エラー確認
- **期待結果**: 全アクセス成功

#### Test Case 5.2: 開始・停止の競合
- **目的**: 同時開始・停止で問題なし
- **前提条件**: WeatherThreadインスタンス
- **テストステップ**:
  1. 複数スレッドからstart/stop
  2. 状態確認
  3. 一貫性確認
- **期待結果**: 状態の一貫性維持

#### Test Case 5.3: リソースリーク防止
- **目的**: 繰り返し開始・停止でリーク無し
- **前提条件**: メモリ監視環境
- **テストステップ**:
  1. 100回開始・停止繰り返し
  2. メモリ使用量確認
  3. スレッド数確認
- **期待結果**: リソースリーク無し

### 6. グレースフルシャットダウンテスト (Graceful Shutdown Tests)

#### Test Case 6.1: 正常停止
- **目的**: 実行中の処理を完了して停止
- **前提条件**: 更新処理中のスレッド
- **テストステップ**:
  1. 更新処理中にstop()
  2. 処理完了待機
  3. 停止確認
- **期待結果**: 処理完了後に停止

#### Test Case 6.2: タイムアウト停止
- **目的**: タイムアウトで強制停止
- **前提条件**: 長時間処理設定
- **テストステップ**:
  1. 無限ループ設定
  2. stop(timeout=1)実行
  3. 強制停止確認
- **期待結果**: 1秒後に強制停止

#### Test Case 6.3: クリーンアップ
- **目的**: 停止時にリソース解放
- **前提条件**: リソース使用中
- **テストステップ**:
  1. スレッド停止
  2. リソース解放確認
  3. 再開可能確認
- **期待結果**: 全リソース解放

### 7. 通知システムテスト (Notification Tests)

#### Test Case 7.1: 更新通知
- **目的**: データ更新時に通知発行
- **前提条件**: 通知リスナー設定
- **テストステップ**:
  1. リスナー登録
  2. データ更新実行
  3. 通知受信確認
- **期待結果**: 更新通知受信

#### Test Case 7.2: エラー通知
- **目的**: エラー時に通知発行
- **前提条件**: エラー発生設定
- **テストステップ**:
  1. エラーリスナー登録
  2. エラー発生
  3. 通知受信確認
- **期待結果**: エラー通知受信

### 8. パフォーマンステスト (Performance Tests)

#### Test Case 8.1: CPU使用率
- **目的**: アイドル時CPU1%以下
- **前提条件**: 長時間実行
- **テストステップ**:
  1. 60秒間実行
  2. CPU使用率測定
  3. 平均値計算
- **期待結果**: 平均1%以下

#### Test Case 8.2: メモリ使用量
- **目的**: メモリ5MB以下
- **前提条件**: 長時間実行
- **テストステップ**:
  1. 初期メモリ測定
  2. 100回更新実行
  3. メモリ増加確認
- **期待結果**: 5MB以下の増加

#### Test Case 8.3: 起動時間
- **目的**: 100ms以内に開始
- **前提条件**: WeatherThreadインスタンス
- **テストステップ**:
  1. 時間測定開始
  2. start()実行
  3. 実行時間確認
- **期待結果**: 100ms以内

## エッジケーステスト

### Edge Case 1: 既に開始済みで再開始
- 二重開始の防止確認

### Edge Case 2: 停止済みで再停止
- 二重停止の安全性確認

### Edge Case 3: 高頻度更新
- 1秒間隔での安定動作

### Edge Case 4: プロバイダ応答遅延
- タイムアウト処理確認

### Edge Case 5: キャッシュ書き込み失敗
- エラー時の継続動作

## テストデータ

### モック天気データ
```python
mock_weather_data = {
    "updated": 1705123200,
    "location": {"latitude": 35.681, "longitude": 139.767},
    "forecasts": [
        {"date": "2025-01-11", "icon": "sunny", "temperature": {"min": 5, "max": 13}}
    ]
}
```

### スレッド設定
```python
test_thread_settings = {
    "weather": {
        "thread": {
            "enabled": True,
            "update_interval": 1,  # 1秒（テスト用）
            "retry_interval": 1,
            "max_retries": 3,
            "retry_backoff": 2.0
        }
    }
}
```

## 実装優先度

### Priority 1 (Critical) - 12テストケース
- Test Case 1.1, 1.2, 1.3 (基本機能)
- Test Case 2.1, 2.2 (定期更新)
- Test Case 3.1 (状態管理)
- Test Case 4.1 (エラー処理)
- Test Case 5.1 (スレッド安全性)
- Test Case 6.1 (シャットダウン)
- Test Case 7.1 (通知)
- Test Case 8.1 (パフォーマンス)

### Priority 2 (Important) - 10テストケース
- Test Case 2.3 (データ取得)
- Test Case 3.2, 3.3 (追加状態管理)
- Test Case 4.2, 4.3 (詳細エラー処理)
- Test Case 5.2, 5.3 (追加安全性)
- Test Case 6.2, 6.3 (追加シャットダウン)
- Test Case 7.2 (エラー通知)

### Priority 3 (Nice to have) - 5テストケース
- Test Case 8.2, 8.3 (追加パフォーマンス)
- Edge Caseテスト群

**合計テストケース数**: 27ケース
**実装目標カバレッジ**: 90%以上
**実行時間目標**: 全テスト30秒以内