# TASK-303: 天気キャッシュシステム実装 - テストケース設計

## テスト戦略概要

WeatherCacheクラスの包括的なテストケースを設計する。キャッシュの読み書き、有効期限管理、LRU戦略、エラーハンドリング、フォールバック機能を含む全機能を検証する。

## テストカテゴリ

### 1. 基本機能テスト (Basic Functionality Tests)

#### Test Case 1.1: WeatherCache初期化
- **目的**: WeatherCacheが正しく初期化されること
- **前提条件**: 正常な設定辞書
- **テストステップ**:
  1. 設定辞書を準備
  2. WeatherCacheを初期化
  3. キャッシュディレクトリの作成確認
- **期待結果**: エラーなく初期化完了、ディレクトリ作成

#### Test Case 1.2: キャッシュ保存（set）
- **目的**: データが正しくキャッシュに保存されること
- **前提条件**: WeatherCacheインスタンス
- **テストステップ**:
  1. キーとデータを準備
  2. set()メソッド実行
  3. ファイル作成確認
- **期待結果**: True返却、ファイル作成

#### Test Case 1.3: キャッシュ取得（get）
- **目的**: 保存したデータが取得できること
- **前提条件**: 保存済みキャッシュ
- **テストステップ**:
  1. データを保存
  2. get()メソッド実行
  3. データ一致確認
- **期待結果**: 保存したデータと同一

### 2. 有効期限管理テスト (TTL Management Tests)

#### Test Case 2.1: 有効期限内のキャッシュ取得
- **目的**: TTL内のキャッシュが取得できること
- **前提条件**: TTL=30分設定
- **テストステップ**:
  1. データ保存
  2. 即座にget()実行
  3. データ確認
- **期待結果**: データ取得成功

#### Test Case 2.2: 有効期限切れのキャッシュ
- **目的**: TTL超過後はNoneが返ること
- **前提条件**: TTL=1秒設定
- **テストステップ**:
  1. データ保存
  2. 2秒待機
  3. get()実行
- **期待結果**: None返却

#### Test Case 2.3: フォールバックモード
- **目的**: エラー時は期限切れでもデータ返却
- **前提条件**: fallback_on_error=True
- **テストステップ**:
  1. 期限切れキャッシュ作成
  2. フォールバックモードでget()
  3. データ確認
- **期待結果**: 期限切れデータ返却

### 3. キャッシュキー生成テスト (Cache Key Generation Tests)

#### Test Case 3.1: 標準キー生成
- **目的**: プロバイダと位置情報からキー生成
- **前提条件**: 位置情報辞書
- **テストステップ**:
  1. generate_cache_key()実行
  2. キー形式確認
  3. 一意性確認
- **期待結果**: "provider_lat_lon"形式

#### Test Case 3.2: 異なる位置の異なるキー
- **目的**: 位置が異なれば別キー生成
- **前提条件**: 2つの異なる位置
- **テストステップ**:
  1. 位置1でキー生成
  2. 位置2でキー生成
  3. キー比較
- **期待結果**: 異なるキー

#### Test Case 3.3: 同一位置の同一キー
- **目的**: 同じ位置なら同じキー生成
- **前提条件**: 同一位置情報
- **テストステップ**:
  1. 2回キー生成
  2. キー比較
- **期待結果**: 同一キー

### 4. LRU管理テスト (LRU Management Tests)

#### Test Case 4.1: エントリ数制限
- **目的**: max_entries超過時に古いエントリ削除
- **前提条件**: max_entries=3
- **テストステップ**:
  1. 4つのエントリ保存
  2. 最古エントリ確認
  3. エントリ数確認
- **期待結果**: 最古削除、3エントリ維持

#### Test Case 4.2: サイズ制限
- **目的**: max_size超過時に古いエントリ削除
- **前提条件**: max_size=1KB
- **テストステップ**:
  1. 大きなデータ複数保存
  2. 合計サイズ確認
  3. 古いエントリ確認
- **期待結果**: サイズ制限内に収まる

#### Test Case 4.3: アクセス順序の更新
- **目的**: アクセスしたエントリのLRU順位更新
- **前提条件**: 複数エントリ
- **テストステップ**:
  1. 古いエントリにアクセス
  2. 新規エントリ追加
  3. 削除対象確認
- **期待結果**: アクセスしたエントリは残る

### 5. get_or_fetchテスト (Get or Fetch Tests)

#### Test Case 5.1: キャッシュヒット時
- **目的**: キャッシュがあればfetcher呼ばない
- **前提条件**: 有効なキャッシュ
- **テストステップ**:
  1. データ保存
  2. get_or_fetch()実行
  3. fetcher呼び出し確認
- **期待結果**: fetcherは呼ばれない

#### Test Case 5.2: キャッシュミス時
- **目的**: キャッシュなければfetcher実行
- **前提条件**: 空のキャッシュ
- **テストステップ**:
  1. get_or_fetch()実行
  2. fetcher呼び出し確認
  3. 結果のキャッシュ確認
- **期待結果**: fetcher実行、結果キャッシュ

#### Test Case 5.3: fetcher例外時
- **目的**: fetcher例外でもキャッシュ返却
- **前提条件**: 期限切れキャッシュ
- **テストステップ**:
  1. 例外を投げるfetcher準備
  2. get_or_fetch()実行
  3. 返却値確認
- **期待結果**: 期限切れキャッシュ返却

### 6. クリーンアップテスト (Cleanup Tests)

#### Test Case 6.1: 期限切れエントリ削除
- **目的**: cleanup()で期限切れ削除
- **前提条件**: 期限切れエントリ複数
- **テストステップ**:
  1. 期限切れエントリ作成
  2. cleanup()実行
  3. 削除数確認
- **期待結果**: 期限切れのみ削除

#### Test Case 6.2: 特定キーの無効化
- **目的**: invalidate()で特定キー削除
- **前提条件**: 複数エントリ
- **テストステップ**:
  1. invalidate(key)実行
  2. 対象エントリ確認
  3. 他エントリ確認
- **期待結果**: 指定キーのみ削除

#### Test Case 6.3: 全キャッシュクリア
- **目的**: invalidate()で全削除
- **前提条件**: 複数エントリ
- **テストステップ**:
  1. invalidate()実行（キーなし）
  2. エントリ数確認
  3. ディレクトリ確認
- **期待結果**: 全エントリ削除

### 7. エラーハンドリングテスト (Error Handling Tests)

#### Test Case 7.1: ディレクトリ作成失敗
- **目的**: 権限エラー時のフォールバック
- **前提条件**: 書き込み不可ディレクトリ
- **テストステップ**:
  1. 権限なしディレクトリ指定
  2. WeatherCache初期化
  3. メモリキャッシュ確認
- **期待結果**: メモリモードで動作

#### Test Case 7.2: ファイル破損時
- **目的**: 破損ファイルの自動削除
- **前提条件**: 不正JSONファイル
- **テストステップ**:
  1. 破損ファイル作成
  2. get()実行
  3. ファイル確認
- **期待結果**: None返却、ファイル削除

#### Test Case 7.3: ディスク容量不足
- **目的**: 書き込み失敗の適切な処理
- **前提条件**: モック化したOS error
- **テストステップ**:
  1. OSError発生設定
  2. set()実行
  3. 返却値確認
- **期待結果**: False返却、エラーログ

### 8. 並行アクセステスト (Concurrent Access Tests)

#### Test Case 8.1: 同時読み取り
- **目的**: 複数スレッドから安全に読み取り
- **前提条件**: マルチスレッド環境
- **テストステップ**:
  1. 10スレッドで同時get()
  2. 結果確認
  3. エラー確認
- **期待結果**: 全スレッド成功

#### Test Case 8.2: 同時書き込み
- **目的**: 複数スレッドから安全に書き込み
- **前提条件**: マルチスレッド環境
- **テストステップ**:
  1. 10スレッドで異なるキー書き込み
  2. ファイル数確認
  3. データ整合性確認
- **期待結果**: 全データ正常保存

#### Test Case 8.3: 読み書き競合
- **目的**: 読み書き同時実行の安全性
- **前提条件**: マルチスレッド環境
- **テストステップ**:
  1. 読みと書きを同時実行
  2. データ整合性確認
  3. エラー確認
- **期待結果**: データ破損なし

### 9. パフォーマンステスト (Performance Tests)

#### Test Case 9.1: キャッシュヒット速度
- **目的**: 10ms以内の応答確認
- **前提条件**: 保存済みキャッシュ
- **テストステップ**:
  1. 時間計測開始
  2. get()実行
  3. 実行時間確認
- **期待結果**: 10ms以内

#### Test Case 9.2: 大量エントリ処理
- **目的**: 100エントリでの安定動作
- **前提条件**: 100エントリ保存
- **テストステップ**:
  1. 100エントリ作成
  2. ランダムアクセス
  3. パフォーマンス測定
- **期待結果**: 安定動作、50ms以内

#### Test Case 9.3: メモリ使用量
- **目的**: メモリ制限内での動作
- **前提条件**: メモリ監視環境
- **テストステップ**:
  1. 初期メモリ測定
  2. キャッシュ操作実行
  3. メモリ増加測定
- **期待結果**: 5MB以内の増加

## エッジケーステスト

### Edge Case 1: 空のキャッシュディレクトリ
- 初回起動時の動作確認

### Edge Case 2: 巨大データ
- max_sizeを超えるデータの処理

### Edge Case 3: 無効な設定値
- 負のTTL、0のmax_entries等

### Edge Case 4: 特殊文字を含むキー
- ファイル名として問題のある文字

### Edge Case 5: 同一ミリ秒での複数操作
- タイムスタンプ衝突の処理

## テストデータ

### 正常な天気データ
```python
test_weather_data = {
    "updated": 1705123200,
    "location": {
        "latitude": 35.681236,
        "longitude": 139.767125
    },
    "forecasts": [
        {
            "date": "2025-01-11",
            "icon": "sunny",
            "temperature": {"min": 5, "max": 13},
            "precipitation_probability": 30
        }
    ]
}
```

### キャッシュ設定
```python
test_cache_settings = {
    "weather": {
        "cache": {
            "enabled": True,
            "directory": "/tmp/test_cache",
            "ttl": 1800,  # 30分
            "max_size": 1048576,  # 1MB
            "max_entries": 10,
            "fallback_on_error": True
        }
    }
}
```

## 実装優先度

### Priority 1 (Critical) - 15テストケース
- Test Case 1.1, 1.2, 1.3 (基本機能)
- Test Case 2.1, 2.2 (有効期限)
- Test Case 3.1 (キー生成)
- Test Case 4.1 (LRU基本)
- Test Case 5.1, 5.2 (get_or_fetch)
- Test Case 6.1, 6.2 (クリーンアップ)
- Test Case 7.2 (エラー回復)
- Test Case 8.1 (並行読み取り)
- Test Case 9.1 (パフォーマンス基本)

### Priority 2 (Important) - 10テストケース
- Test Case 2.3 (フォールバック)
- Test Case 3.2, 3.3 (キー詳細)
- Test Case 4.2, 4.3 (LRU詳細)
- Test Case 5.3 (例外処理)
- Test Case 6.3 (全削除)
- Test Case 7.1, 7.3 (追加エラー)
- Test Case 8.2, 8.3 (並行書き込み)

### Priority 3 (Nice to have) - 5テストケース
- Test Case 9.2, 9.3 (パフォーマンス詳細)
- Edge Caseテスト群

## テスト実装計画

1. **フェーズ1**: 基本機能とキャッシュ操作
2. **フェーズ2**: 有効期限とLRU管理
3. **フェーズ3**: エラーハンドリングと並行処理
4. **フェーズ4**: パフォーマンスと統合テスト

**合計テストケース数**: 30ケース
**実装目標カバレッジ**: 95%以上
**実行時間目標**: 全テスト10秒以内