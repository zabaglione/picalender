# TASK-303: 天気キャッシュシステム実装 - 要件定義

## 概要

天気プロバイダから取得したデータをキャッシュし、ネットワーク断やAPI制限時でも天気情報を表示できるようにする。キャッシュはファイルシステムベースで実装し、有効期限管理とフォールバック機能を提供する。

## 基本要件

### 1. キャッシュストレージ
- **保存形式**: JSON形式でファイルシステムに保存
- **保存場所**: `~/.cache/picalendar/weather/` または設定で指定
- **ファイル名**: `weather_cache_{provider}_{location_hash}.json`
- **権限管理**: ユーザー読み書き権限のみ（600）

### 2. キャッシュ管理
- **有効期限**: デフォルト30分（設定可能）
- **最大サイズ**: 10MB（設定可能）
- **エントリ数制限**: 100エントリまで
- **LRU戦略**: 最も古いエントリから削除

### 3. キャッシュ操作
- **読み取り**: 有効期限内のキャッシュを返す
- **書き込み**: 新規データをキャッシュに保存
- **無効化**: 期限切れエントリの自動削除
- **クリア**: 全キャッシュの手動削除

### 4. フォールバック機能
- **ネットワークエラー時**: 期限切れでも最後のキャッシュを使用
- **グレースフル劣化**: 古いデータでも表示継続
- **ステータス表示**: キャッシュデータ使用中の通知

## 技術要件

### 1. WeatherCacheクラス

```python
class WeatherCache:
    """天気データキャッシュ管理クラス"""
    
    def __init__(self, settings: Dict[str, Any]):
        """初期化
        
        Args:
            settings: 設定辞書（cache_dir, ttl, max_size等）
        """
        pass
    
    def get(self, key: str) -> Optional[Dict[str, Any]]:
        """キャッシュ取得
        
        Args:
            key: キャッシュキー
            
        Returns:
            キャッシュデータまたはNone
        """
        pass
    
    def set(self, key: str, data: Dict[str, Any]) -> bool:
        """キャッシュ保存
        
        Args:
            key: キャッシュキー
            data: 保存するデータ
            
        Returns:
            保存成功の場合True
        """
        pass
    
    def get_or_fetch(self, key: str, fetcher: Callable) -> Dict[str, Any]:
        """キャッシュ取得または新規取得
        
        Args:
            key: キャッシュキー
            fetcher: データ取得関数
            
        Returns:
            キャッシュまたは新規取得データ
        """
        pass
    
    def invalidate(self, key: str = None) -> int:
        """キャッシュ無効化
        
        Args:
            key: 特定キーまたはNone（全て）
            
        Returns:
            削除されたエントリ数
        """
        pass
    
    def cleanup(self) -> int:
        """期限切れエントリのクリーンアップ
        
        Returns:
            削除されたエントリ数
        """
        pass
```

### 2. キャッシュキー生成

```python
def generate_cache_key(provider: str, location: Dict[str, Any]) -> str:
    """キャッシュキー生成
    
    Args:
        provider: プロバイダ名（openmeteo, yahoo等）
        location: 位置情報（latitude, longitude）
        
    Returns:
        ユニークなキャッシュキー
    """
    # 例: "openmeteo_35.681_139.767"
    pass
```

### 3. キャッシュエントリ形式

```json
{
    "key": "openmeteo_35.681_139.767",
    "data": {
        "updated": 1705123200,
        "location": {...},
        "forecasts": [...]
    },
    "metadata": {
        "created_at": 1705123200,
        "expires_at": 1705125000,
        "hit_count": 5,
        "provider": "openmeteo",
        "version": "1.0"
    }
}
```

### 4. 設定オプション

```yaml
weather:
  cache:
    enabled: true
    directory: "~/.cache/picalendar/weather"
    ttl: 1800  # 30分（秒）
    max_size: 10485760  # 10MB
    max_entries: 100
    fallback_on_error: true
    cleanup_interval: 3600  # 1時間ごと
```

## 機能仕様

### 1. キャッシュヒット判定
1. キーに対応するファイルの存在確認
2. ファイルの読み込みと解析
3. 有効期限の確認
4. 有効な場合はデータ返却
5. 無効な場合はNone返却（またはフォールバック）

### 2. キャッシュ更新フロー
1. 新規データの取得
2. キャッシュキーの生成
3. メタデータの付与
4. ファイルへの書き込み
5. 古いエントリの削除（必要に応じて）

### 3. エラー回復戦略
- **ファイル破損**: 破損ファイルを削除し再取得
- **権限エラー**: メモリキャッシュにフォールバック
- **容量不足**: 古いエントリを削除して再試行
- **IOエラー**: ログ記録し、キャッシュ無効で継続

### 4. パフォーマンス最適化
- **メモリキャッシュ**: 頻繁アクセスデータのメモリ保持
- **非同期書き込み**: UIブロッキングの回避
- **バッチクリーンアップ**: 定期的な一括削除
- **圧縮**: 大きなデータの圧縮保存（オプション）

## セキュリティ要件

### 1. ファイルシステムセキュリティ
- **権限設定**: 600（所有者のみ読み書き）
- **ディレクトリ権限**: 700（所有者のみアクセス）
- **パス検証**: ディレクトリトラバーサル防止
- **サニタイズ**: ファイル名の安全性確保

### 2. データ検証
- **JSON検証**: 不正なJSONの拒否
- **スキーマ検証**: 期待される構造の確認
- **サイズ制限**: 巨大データの拒否
- **型チェック**: データ型の妥当性確認

## エラーハンドリング

### 1. 例外クラス

```python
class CacheError(Exception):
    """キャッシュ関連エラーの基底クラス"""
    pass

class CacheReadError(CacheError):
    """キャッシュ読み取りエラー"""
    pass

class CacheWriteError(CacheError):
    """キャッシュ書き込みエラー"""
    pass

class CacheInvalidError(CacheError):
    """キャッシュ無効エラー"""
    pass
```

### 2. エラー処理方針
- **読み取りエラー**: Noneを返し、新規取得を促す
- **書き込みエラー**: ログ記録、キャッシュなしで継続
- **クリーンアップエラー**: ログ記録、次回再試行
- **初期化エラー**: フォールバックモード（メモリのみ）

## パフォーマンス要件

### 1. レスポンス時間
- **キャッシュヒット**: 10ms以内
- **キャッシュミス**: 50ms以内（ファイル操作含む）
- **クリーンアップ**: 100ms以内
- **初期化**: 50ms以内

### 2. リソース使用量
- **メモリ**: 最大5MB（メモリキャッシュ）
- **ディスク**: 最大10MB（設定可能）
- **CPU**: 1%以下（通常動作時）
- **ファイルハンドル**: 最大10個

## 受け入れ基準

### ✅ 基本機能
- [ ] キャッシュの読み書きが正常動作
- [ ] 有効期限管理が機能
- [ ] LRU戦略による古いエントリ削除
- [ ] フォールバック機能の動作

### ✅ エラー処理
- [ ] ネットワーク断時のキャッシュ利用
- [ ] ファイル破損時の回復
- [ ] 容量超過時の適切な処理
- [ ] 権限エラーのハンドリング

### ✅ パフォーマンス
- [ ] キャッシュヒット時10ms以内
- [ ] メモリ使用量5MB以内
- [ ] 100エントリでの安定動作
- [ ] 並行アクセスの安全性

### ✅ 統合
- [ ] WeatherProviderとの連携
- [ ] 設定システムとの統合
- [ ] ログシステムへの出力
- [ ] エラー通知の実装

## 実装ファイル構成

```
src/weather/
├── cache/
│   ├── __init__.py
│   ├── weather_cache.py    # メインキャッシュクラス
│   ├── cache_key.py        # キー生成ユーティリティ
│   └── exceptions.py       # キャッシュ例外クラス
```

## テスト要件

### 1. 単体テスト
- キャッシュ読み書きの正常系
- 有効期限の境界値テスト
- LRU削除のテスト
- エラー処理のテスト

### 2. 統合テスト
- WeatherProviderとの連携テスト
- 並行アクセステスト
- パフォーマンステスト
- フォールバックシナリオ

### 3. エッジケース
- 空のキャッシュ
- 満杯のキャッシュ
- 破損ファイル
- 権限なしディレクトリ

## 制限事項

### 1. 現在の制限
- ファイルシステムベース（DBなし）
- 同期的な書き込み
- ローカルキャッシュのみ
- 圧縮未対応

### 2. 将来の拡張
- Redis/Memcached対応
- 非同期I/O
- 分散キャッシュ
- データ圧縮

この要件定義に基づき、堅牢で効率的な天気キャッシュシステムを実装する。