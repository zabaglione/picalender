# TASK-302: Open-Meteoプロバイダ実装 - テストケース設計

## テスト戦略概要

OpenMeteoProviderクラスの包括的なテストケースを設計する。WeatherProvider基底クラスの継承、Open-Meteo API連携、データ変換、WMOコードマッピング、エラーハンドリングを含む全機能を検証する。

## テストカテゴリ

### 1. 基本機能テスト (Basic Functionality Tests)

#### Test Case 1.1: OpenMeteoProvider初期化
- **目的**: OpenMeteoProviderが正しく初期化されること
- **前提条件**: 正常な設定辞書
- **テストステップ**:
  1. 設定辞書を準備
  2. OpenMeteoProviderを初期化
  3. 基底クラスの初期化確認
- **期待結果**: エラーなく初期化完了、WeatherProvider継承確認

#### Test Case 1.2: fetch()メソッド実装確認
- **目的**: 抽象メソッドfetch()が実装されていること
- **前提条件**: OpenMeteoProviderインスタンス
- **テストステップ**:
  1. fetch()メソッドの存在確認
  2. 呼び出し可能性確認
  3. 戻り値の型確認
- **期待結果**: fetch()が実装され、辞書を返す

#### Test Case 1.3: BASE_URL定数確認
- **目的**: Open-Meteo APIのベースURLが正しく定義されていること
- **前提条件**: OpenMeteoProviderクラス
- **テストステップ**:
  1. BASE_URL定数の存在確認
  2. URL形式の確認
  3. HTTPSプロトコル確認
- **期待結果**: 正しいOpen-Meteo APIエンドポイント

### 2. APIリクエスト構築テスト (API Request Building Tests)

#### Test Case 2.1: リクエストパラメータ構築
- **目的**: 正しいAPIリクエストパラメータが構築されること
- **前提条件**: 緯度経度設定済み
- **テストステップ**:
  1. _build_request_params()実行
  2. 必須パラメータ確認
  3. daily配列の内容確認
- **期待結果**: 正しいパラメータ辞書が生成される

#### Test Case 2.2: 緯度経度の反映
- **目的**: 設定の緯度経度がパラメータに反映されること
- **前提条件**: 特定の緯度経度設定
- **テストステップ**:
  1. 東京の座標で設定
  2. パラメータ構築
  3. 座標値の確認
- **期待結果**: 設定値が正確に反映される

#### Test Case 2.3: タイムゾーン設定
- **目的**: Asia/Tokyoタイムゾーンが設定されること
- **前提条件**: OpenMeteoProviderインスタンス
- **テストステップ**:
  1. パラメータ構築
  2. timezone フィールド確認
  3. 値の検証
- **期待結果**: "Asia/Tokyo"が設定される

#### Test Case 2.4: 予報日数設定
- **目的**: 3日分の予報が要求されること
- **前提条件**: OpenMeteoProviderインスタンス
- **テストステップ**:
  1. パラメータ構築
  2. forecast_days フィールド確認
  3. 値の検証
- **期待結果**: forecast_days=3が設定される

### 3. レスポンス変換テスト (Response Conversion Tests)

#### Test Case 3.1: 正常レスポンス変換
- **目的**: Open-Meteo形式が標準形式に正しく変換されること
- **前提条件**: 正常なOpen-Meteoレスポンス
- **テストステップ**:
  1. モックレスポンスで_parse_openmeteo_response()実行
  2. 標準形式の構造確認
  3. 各フィールドの検証
- **期待結果**: 標準形式の辞書が生成される

#### Test Case 3.2: 日次データ変換
- **目的**: 日次データが正しく変換されること
- **前提条件**: Open-Meteoの日次データ
- **テストステップ**:
  1. 3日分のデータで変換実行
  2. 各日の予報データ確認
  3. フィールドマッピング確認
- **期待結果**: 3日分の予報データが生成される

#### Test Case 3.3: 温度データ変換
- **目的**: 温度が正しく摂氏で変換されること
- **前提条件**: 温度データ含有レスポンス
- **テストステップ**:
  1. 最高・最低気温の変換
  2. 数値型の確認
  3. 妥当な範囲の確認
- **期待結果**: min/max温度が正しく設定される

#### Test Case 3.4: 降水確率変換
- **目的**: 降水確率が0-100%で変換されること
- **前提条件**: 降水確率データ
- **テストステップ**:
  1. 降水確率の変換
  2. 範囲チェック（0-100）
  3. 整数変換確認
- **期待結果**: 正しい降水確率が設定される

#### Test Case 3.5: 日付形式変換
- **目的**: 日付がYYYY-MM-DD形式で設定されること
- **前提条件**: 日付データ
- **テストステップ**:
  1. Open-Meteoの日付配列処理
  2. 各日付の形式確認
  3. 正規表現での検証
- **期待結果**: ISO 8601形式の日付文字列

### 4. WMOコードマッピングテスト (WMO Code Mapping Tests)

#### Test Case 4.1: 晴れコードマッピング
- **目的**: WMOコード0-1が"sunny"にマッピングされること
- **前提条件**: WMOコード0, 1
- **テストステップ**:
  1. コード0で_map_wmo_code_to_icon()実行
  2. コード1で実行
  3. 戻り値確認
- **期待結果**: "sunny"が返される

#### Test Case 4.2: 曇りコードマッピング
- **目的**: WMOコード2-3が"cloudy"にマッピングされること
- **前提条件**: WMOコード2, 3
- **テストステップ**:
  1. 各コードでマッピング実行
  2. 戻り値確認
- **期待結果**: "cloudy"が返される

#### Test Case 4.3: 雨コードマッピング
- **目的**: 雨関連コードが"rain"にマッピングされること
- **前提条件**: WMOコード51-67, 80-82
- **テストステップ**:
  1. 各雨コードでマッピング実行
  2. 戻り値確認
- **期待結果**: "rain"が返される

#### Test Case 4.4: 雷コードマッピング
- **目的**: WMOコード95, 96, 99が"thunder"にマッピングされること
- **前提条件**: 雷関連コード
- **テストステップ**:
  1. 各コードでマッピング実行
  2. 戻り値確認
- **期待結果**: "thunder"が返される

#### Test Case 4.5: 霧コードマッピング
- **目的**: WMOコード45, 48が"fog"にマッピングされること
- **前提条件**: 霧関連コード
- **テストステップ**:
  1. 各コードでマッピング実行
  2. 戻り値確認
- **期待結果**: "fog"が返される

#### Test Case 4.6: 不明コードのデフォルト処理
- **目的**: 未定義コードで"cloudy"が返されること
- **前提条件**: マッピングにないコード
- **テストステップ**:
  1. コード999でマッピング実行
  2. 戻り値確認
  3. ログ出力確認
- **期待結果**: デフォルト"cloudy"が返される

### 5. データ取得フローテスト (Data Fetch Flow Tests)

#### Test Case 5.1: 完全fetch()フロー
- **目的**: fetch()メソッドの全工程が正常動作すること
- **前提条件**: モックHTTPレスポンス
- **テストステップ**:
  1. fetch()メソッド実行
  2. APIリクエスト確認
  3. 変換処理確認
  4. 戻り値検証
- **期待結果**: 標準形式のデータが返される

#### Test Case 5.2: タイムスタンプ設定
- **目的**: updatedフィールドに現在時刻が設定されること
- **前提条件**: fetch()実行
- **テストステップ**:
  1. fetch()実行前の時刻記録
  2. fetch()実行
  3. updatedフィールド確認
- **期待結果**: 現在のUNIXタイムスタンプ

#### Test Case 5.3: location情報設定
- **目的**: 位置情報が正しく設定されること
- **前提条件**: 緯度経度設定
- **テストステップ**:
  1. fetch()実行
  2. locationフィールド確認
  3. 座標値の検証
- **期待結果**: 設定と同じ緯度経度

### 6. エラーハンドリングテスト (Error Handling Tests)

#### Test Case 6.1: ネットワークエラー処理
- **目的**: 接続エラー時にNetworkError例外が発生すること
- **前提条件**: ネットワークエラーモック
- **テストステップ**:
  1. 接続エラーを発生させる
  2. fetch()実行
  3. 例外キャッチ
- **期待結果**: NetworkError例外発生

#### Test Case 6.2: APIエラー処理
- **目的**: HTTP 4XX/5XXでAPIError例外が発生すること
- **前提条件**: エラーレスポンスモック
- **テストステップ**:
  1. 400エラーレスポンス設定
  2. fetch()実行
  3. 例外確認
- **期待結果**: APIError例外発生

#### Test Case 6.3: 不正レスポンス処理
- **目的**: 不正なJSONでDataFormatError例外が発生すること
- **前提条件**: 不正形式レスポンス
- **テストステップ**:
  1. 必須フィールド欠如データ
  2. fetch()実行
  3. 例外確認
- **期待結果**: DataFormatError例外発生

#### Test Case 6.4: タイムアウト処理
- **目的**: タイムアウト時に適切な例外が発生すること
- **前提条件**: タイムアウトモック
- **テストステップ**:
  1. 10秒超の遅延設定
  2. fetch()実行
  3. 例外確認
- **期待結果**: NetworkError例外（タイムアウト）

### 7. 統合テスト (Integration Tests)

#### Test Case 7.1: 基底クラス機能統合
- **目的**: WeatherProvider基底クラスの機能が正常動作すること
- **前提条件**: OpenMeteoProviderインスタンス
- **テストステップ**:
  1. 設定管理機能確認
  2. HTTPクライアント使用確認
  3. ログ出力確認
  4. cleanup()動作確認
- **期待結果**: 基底クラス機能が全て動作

#### Test Case 7.2: 実際のAPI通信テスト
- **目的**: 実際のOpen-Meteo APIと通信できること
- **前提条件**: インターネット接続
- **テストステップ**:
  1. 実際のAPIでfetch()実行
  2. レスポンス受信確認
  3. データ変換確認
- **期待結果**: 実データの取得成功（CI/CD環境ではスキップ）

#### Test Case 7.3: 異なる座標での動作
- **目的**: 様々な緯度経度で正常動作すること
- **前提条件**: 複数の座標設定
- **テストステップ**:
  1. 東京、ニューヨーク、ロンドンで実行
  2. 各レスポンス確認
  3. 座標反映確認
- **期待結果**: 全座標で正常動作

### 8. パフォーマンステスト (Performance Tests)

#### Test Case 8.1: レスポンス時間測定
- **目的**: API呼び出しが3秒以内に完了すること
- **前提条件**: 通常のネットワーク環境
- **テストステップ**:
  1. 時間計測開始
  2. fetch()実行
  3. 実行時間確認
- **期待結果**: 3秒以内で完了

#### Test Case 8.2: メモリ使用量測定
- **目的**: メモリ使用量が1MB以下であること
- **前提条件**: メモリ監視環境
- **テストステップ**:
  1. 初期メモリ測定
  2. fetch()実行
  3. メモリ増加確認
- **期待結果**: 1MB以下の増加

#### Test Case 8.3: 並行実行安全性
- **目的**: 複数インスタンスが同時実行可能なこと
- **前提条件**: マルチスレッド環境
- **テストステップ**:
  1. 3つのインスタンス作成
  2. 同時にfetch()実行
  3. 結果確認
- **期待結果**: 全て正常完了

## エッジケーステスト

### Edge Case 1: 空の日次データ
- Open-Meteoが空の配列を返した場合の処理

### Edge Case 2: 部分的データ欠損
- 一部の日のデータが欠けている場合

### Edge Case 3: 極端な気温値
- -50°C や 60°C などの極端な値

### Edge Case 4: 未来の日付
- サーバー時刻のずれによる未来日付

### Edge Case 5: 負の降水確率
- データエラーによる負値

## テストデータ

### 正常なOpen-Meteoレスポンス
```python
mock_openmeteo_response = {
    "latitude": 35.6812,
    "longitude": 139.7671,
    "timezone": "Asia/Tokyo",
    "timezone_abbreviation": "JST",
    "elevation": 35.0,
    "daily": {
        "time": ["2025-01-11", "2025-01-12", "2025-01-13"],
        "temperature_2m_max": [12.5, 8.3, 7.1],
        "temperature_2m_min": [5.2, 3.1, 4.0],
        "weathercode": [1, 3, 61],
        "precipitation_probability_max": [30, 60, 90]
    }
}
```

### WMOコードテストデータ
```python
wmo_code_tests = [
    (0, "sunny"),     # Clear sky
    (1, "sunny"),     # Mainly clear
    (2, "cloudy"),    # Partly cloudy
    (3, "cloudy"),    # Overcast
    (45, "fog"),      # Foggy
    (48, "fog"),      # Rime fog
    (51, "rain"),     # Light drizzle
    (61, "rain"),     # Slight rain
    (63, "rain"),     # Moderate rain
    (65, "rain"),     # Heavy rain
    (80, "rain"),     # Rain showers
    (95, "thunder"),  # Thunderstorm
    (96, "thunder"),  # Thunderstorm with hail
    (71, "rain"),     # Light snow (as rain)
    (999, "cloudy"),  # Unknown code (default)
]
```

### エラーレスポンステストデータ
```python
error_responses = {
    "missing_daily": {
        "latitude": 35.6812,
        "longitude": 139.7671,
        "timezone": "Asia/Tokyo"
        # daily フィールドなし
    },
    "invalid_structure": {
        "daily": "not_a_dict"  # 不正な構造
    },
    "partial_data": {
        "daily": {
            "time": ["2025-01-11"],
            "temperature_2m_max": [12.5],
            # 他のフィールド欠如
        }
    }
}
```

## 実装優先度

### Priority 1 (Critical) - 15テストケース
- Test Case 1.1, 1.2 (基本初期化)
- Test Case 2.1 (リクエスト構築)
- Test Case 3.1, 3.2 (レスポンス変換基本)
- Test Case 4.1-4.5 (WMOマッピング基本)
- Test Case 5.1 (fetch()フロー)
- Test Case 6.1, 6.3 (エラー処理基本)
- Test Case 7.1 (基底クラス統合)

### Priority 2 (Important) - 10テストケース
- Test Case 1.3 (定数確認)
- Test Case 2.2, 2.3, 2.4 (パラメータ詳細)
- Test Case 3.3, 3.4, 3.5 (データ変換詳細)
- Test Case 4.6 (デフォルト処理)
- Test Case 5.2, 5.3 (データ詳細)
- Test Case 6.2, 6.4 (追加エラー)

### Priority 3 (Nice to have) - 6テストケース
- Test Case 7.2, 7.3 (実API・複数座標)
- Test Case 8.1, 8.2, 8.3 (パフォーマンス)
- Edge Case テスト群

## テスト実装計画

1. **フェーズ1**: 基本機能とWMOマッピングテスト
2. **フェーズ2**: API連携とデータ変換テスト
3. **フェーズ3**: エラーハンドリングと統合テスト
4. **フェーズ4**: パフォーマンスとエッジケーステスト

各フェーズでRed-Green-Refactorサイクルを実行し、継続的に品質を確保する。

**合計テストケース数**: 31ケース
**実装目標カバレッジ**: 95%以上
**実行時間目標**: 全テスト30秒以内