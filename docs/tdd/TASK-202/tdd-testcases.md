# TASK-202: 日付レンダラー実装 - テストケース設計

## テスト戦略概要

DateRendererクラスの包括的なテストケースを設計する。単体テスト、統合テスト、パフォーマンステストを含み、ClockRendererとの連携も検証する。

## テストカテゴリ

### 1. 基本機能テスト (Basic Functionality Tests)

#### Test Case 1.1: DateRenderer初期化
- **目的**: DateRendererが正しく初期化されること
- **前提条件**: AssetManagerとsettingsが正常
- **テストステップ**:
  1. AssetManagerインスタンスを作成
  2. 設定辞書を準備
  3. DateRendererを初期化
- **期待結果**: エラーなく初期化完了

#### Test Case 1.2: 現在日付取得
- **目的**: get_current_date()が正しい形式で日付を返すこと
- **前提条件**: DateRendererが初期化済み
- **テストステップ**:
  1. get_current_date()を呼び出し
  2. 戻り値の形式を確認
- **期待結果**: "YYYY-MM-DD (曜日)"形式の文字列

#### Test Case 1.3: 日付フォーマット
- **目的**: _format_date()が正しく日付をフォーマットすること
- **前提条件**: datetimeオブジェクト準備
- **テストステップ**:
  1. 固定のdatetimeオブジェクトを作成
  2. _format_date()でフォーマット
  3. 結果を確認
- **期待結果**: "2024-08-10 (土)"のような正確なフォーマット

### 2. 曜日フォーマットテスト (Weekday Format Tests)

#### Test Case 2.1: 日本語曜日フォーマット
- **目的**: 日本語曜日が正しくフォーマットされること
- **前提条件**: 日本語設定
- **テストステップ**:
  1. 各曜日のdatetimeを作成
  2. _format_weekday()でフォーマット
  3. 日本語曜日を確認
- **期待結果**: "(月)", "(火)", ..., "(日)" の形式

#### Test Case 2.2: 英語曜日フォーマット
- **目的**: 英語曜日が正しくフォーマットされること
- **前提条件**: 英語設定
- **テストステップ**:
  1. 各曜日のdatetimeを作成
  2. _format_weekday()でフォーマット
  3. 英語曜日を確認
- **期待結果**: "(Mon)", "(Tue)", ..., "(Sun)" の形式

#### Test Case 2.3: 曜日フォーマット設定変更
- **目的**: set_weekday_format()で曜日表記が変更されること
- **前提条件**: DateRendererインスタンス
- **テストステップ**:
  1. 日本語で初期化
  2. 英語に変更
  3. フォーマット結果を確認
- **期待結果**: 設定に応じた曜日表記

#### Test Case 2.4: 全曜日網羅テスト
- **目的**: 月曜〜日曜の全曜日が正しく表示されること
- **前提条件**: 各曜日のテストデータ
- **テストステップ**:
  1. 7日分のdatetimeを準備
  2. 各日付でフォーマット実行
  3. 曜日の対応確認
- **期待結果**: 7曜日すべて正確にフォーマット

### 3. レンダリング機能テスト (Rendering Tests)

#### Test Case 3.1: 基本レンダリング
- **目的**: render()メソッドが正常に動作すること
- **前提条件**: pygame初期化済み、サーフェス準備
- **テストステップ**:
  1. pygame.Surfaceを作成
  2. clock_rectを指定
  3. render()メソッド呼び出し
- **期待結果**: サーフェスに日付が描画される

#### Test Case 3.2: 位置計算・配置
- **目的**: 時計直下の正しい位置に描画されること
- **前提条件**: 時計のRectが与えられる
- **テストステップ**:
  1. 時計rect情報を設定
  2. 描画実行
  3. 日付の描画位置を確認
- **期待結果**: 時計の中央下部に配置

#### Test Case 3.3: フォントサイズ設定
- **目的**: 設定されたフォントサイズで描画されること
- **前提条件**: 異なるフォントサイズ設定
- **テストステップ**:
  1. フォントサイズ36pxで設定
  2. レンダリング実行
  3. 描画されたテキストのサイズを確認
- **期待結果**: 指定サイズで描画

### 4. 更新機能テスト (Update Tests)

#### Test Case 4.1: 日付更新
- **目的**: update()メソッドで日付が更新されること
- **前提条件**: DateRenderer初期化済み
- **テストステップ**:
  1. 初期日付を記録
  2. update()呼び出し
  3. 日付の変化を確認
- **期待結果**: 現在日付に更新される

#### Test Case 4.2: 毎分更新動作
- **目的**: 日付が変わった際の更新動作確認
- **前提条件**: 日付変更のモック
- **テストステップ**:
  1. 固定日付でモック
  2. 日付を変更
  3. update()で更新確認
- **期待結果**: 新しい日付に更新

#### Test Case 4.3: 同日での更新スキップ
- **目的**: 同じ日内では再レンダを行わないこと
- **前提条件**: 同日内の時刻変更
- **テストステップ**:
  1. 同日の異なる時刻設定
  2. 複数回update()実行
  3. 再レンダ回数を確認
- **期待結果**: 日付変更時のみ再レンダ

### 5. 設定変更テスト (Configuration Tests)

#### Test Case 5.1: フォントサイズ変更
- **目的**: 設定変更がレンダリングに反映されること
- **前提条件**: 初期設定で描画済み
- **テストステップ**:
  1. フォントサイズを変更
  2. レンダリング実行
  3. サイズ変更を確認
- **期待結果**: 新しいサイズで描画

#### Test Case 5.2: 色設定変更
- **目的**: 日付の色設定が反映されること
- **前提条件**: 色設定準備
- **テストステップ**:
  1. 色設定を変更（青色）
  2. レンダリング実行
  3. 色変更を確認
- **期待結果**: 指定色で描画

#### Test Case 5.3: 曜日表記設定変更
- **目的**: 曜日表記の設定変更が反映されること
- **前提条件**: 初期設定（日本語）
- **テストステップ**:
  1. 英語表記に変更
  2. レンダリング実行
  3. 曜日表記を確認
- **期待結果**: 英語曜日で表示

### 6. エラーハンドリングテスト (Error Handling Tests)

#### Test Case 6.1: フォント読み込み失敗
- **目的**: フォント読み込み失敗時のフォールバック
- **前提条件**: 無効なフォントパス
- **テストステップ**:
  1. 無効なフォントパスを設定
  2. DateRenderer初期化
  3. エラーハンドリング確認
- **期待結果**: システムフォントで正常動作

#### Test Case 6.2: 不正な曜日設定
- **目的**: 不正な曜日フォーマット設定の処理
- **前提条件**: 無効な曜日設定値
- **テストステップ**:
  1. 無効な曜日フォーマットを設定
  2. DateRenderer初期化
  3. デフォルト動作確認
- **期待結果**: デフォルト値（日本語）で動作

#### Test Case 6.3: 空設定処理
- **目的**: 設定が空の場合のデフォルト動作
- **前提条件**: 空の設定辞書
- **テストステップ**:
  1. 空の設定で初期化
  2. レンダリング実行
  3. デフォルト動作確認
- **期待結果**: デフォルト値で正常動作

### 7. 統合テスト (Integration Tests)

#### Test Case 7.1: AssetManager連携
- **目的**: AssetManagerとの連携が正常であること
- **前提条件**: AssetManager初期化済み
- **テストステップ**:
  1. AssetManagerからフォント取得
  2. DateRendererで使用
  3. 正常レンダリング確認
- **期待結果**: フォントキャッシュが活用される

#### Test Case 7.2: ClockRenderer連携
- **目的**: ClockRendererとの位置関係が正常
- **前提条件**: ClockRendererとDateRenderer
- **テストステップ**:
  1. ClockRendererで時計描画
  2. 時計rectを取得
  3. DateRendererで位置計算
  4. 相対位置確認
- **期待結果**: 適切な位置関係で描画

#### Test Case 7.3: 全体ワークフロー
- **目的**: 完全なワークフローが正常動作
- **前提条件**: 統合環境
- **テストステップ**:
  1. 初期化
  2. 更新→描画のサイクル
  3. 設定変更
  4. 再描画確認
- **期待結果**: エラーなく実行完了

### 8. パフォーマンステスト (Performance Tests)

#### Test Case 8.1: CPU使用率測定
- **目的**: 日付描画のCPU負荷測定
- **前提条件**: パフォーマンス測定環境
- **テストステップ**:
  1. 1000回描画実行
  2. CPU使用率測定
  3. 基準値との比較
- **期待結果**: CPU使用率2%以下

#### Test Case 8.2: メモリ使用量測定
- **目的**: メモリリーク検出
- **前提条件**: メモリ監視環境
- **テストステップ**:
  1. 10000回更新・描画
  2. メモリ使用量監視
  3. リーク検出
- **期待結果**: メモリ使用量一定

#### Test Case 8.3: レンダリング性能
- **目的**: レンダリング速度の測定
- **前提条件**: 大量レンダリング環境
- **テストステップ**:
  1. 連続1000回レンダリング
  2. 実行時間測定
  3. 1回あたりの時間計算
- **期待結果**: 1回0.5ms以下

## エッジケーステスト

### Edge Case 1: 年末年始跨ぎ
- 12/31 → 1/1の日付変更表示

### Edge Case 2: うるう年
- 2/28 → 2/29のうるう年対応

### Edge Case 3: 夏時間切り替え
- 夏時間開始/終了時の日付表示

### Edge Case 4: システム時刻変更
- 手動時刻変更時の対応

## テストデータ

### 日付テストデータ
```python
test_dates = [
    datetime(2024, 1, 1),    # 元日・月曜日
    datetime(2024, 2, 29),   # うるう年
    datetime(2024, 8, 10),   # 通常日・土曜日
    datetime(2024, 12, 31),  # 大晦日・火曜日
]
```

### 曜日テストデータ
```python
weekday_data = {
    'japanese': ['(月)', '(火)', '(水)', '(木)', '(金)', '(土)', '(日)'],
    'english': ['(Mon)', '(Tue)', '(Wed)', '(Thu)', '(Fri)', '(Sat)', '(Sun)']
}
```

### 設定テストデータ
```python
test_settings = [
    {
        "ui": {
            "date_font_px": 36,
            "date_color": [255, 255, 255],
            "weekday_format": "japanese"
        }
    },
    {
        "ui": {
            "date_font_px": 48,
            "date_color": [0, 255, 255],
            "weekday_format": "english"
        }
    }
]
```

## 実装優先度

### Priority 1 (High)
- Test Case 1.1, 1.2, 1.3 (基本機能)
- Test Case 2.1, 2.2 (曜日フォーマット)
- Test Case 3.1, 3.2 (基本レンダリング)
- Test Case 4.1 (日付更新)

### Priority 2 (Medium)
- Test Case 5.1, 5.2, 5.3 (設定変更)
- Test Case 7.1, 7.2 (統合テスト)
- Test Case 2.3, 2.4 (曜日拡張)

### Priority 3 (Low)
- Test Case 6.1, 6.2, 6.3 (エラーハンドリング)
- Test Case 8.1, 8.2, 8.3 (パフォーマンス)
- Edge Caseテスト

## テスト実装計画

1. **フェーズ1**: 基本機能テスト実装（日付表示・曜日フォーマット）
2. **フェーズ2**: レンダリング・更新テスト実装
3. **フェーズ3**: 統合・パフォーマンステスト実装

各フェーズでRed-Green-Refactorサイクルを実行し、継続的に品質を確保する。